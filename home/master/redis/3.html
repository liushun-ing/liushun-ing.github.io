<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.62">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <link rel="icon" href="/home/imgs/favicon.ico"><title>Redis高级 | 不愿飞的蜂鸟首页</title><meta name="description" content="Five的垃圾库">
    <link rel="preload" href="/home/assets/style-d11d67ee.css" as="style"><link rel="stylesheet" href="/home/assets/style-d11d67ee.css">
    <link rel="modulepreload" href="/home/assets/app-4044199c.js"><link rel="modulepreload" href="/home/assets/3.html-0aeba0e9.js"><link rel="modulepreload" href="/home/assets/3.html-20b1a547.js"><link rel="prefetch" href="/home/assets/index.html-572e34ff.js" as="script"><link rel="prefetch" href="/home/assets/index.html-81b2fcca.js" as="script"><link rel="prefetch" href="/home/assets/index.html-7e831815.js" as="script"><link rel="prefetch" href="/home/assets/index.html-25f3e375.js" as="script"><link rel="prefetch" href="/home/assets/index.html-6f489083.js" as="script"><link rel="prefetch" href="/home/assets/1.html-b316c5ed.js" as="script"><link rel="prefetch" href="/home/assets/2.html-ac2ea519.js" as="script"><link rel="prefetch" href="/home/assets/3.html-a16fc765.js" as="script"><link rel="prefetch" href="/home/assets/4.html-798018cd.js" as="script"><link rel="prefetch" href="/home/assets/5.html-18ce25f4.js" as="script"><link rel="prefetch" href="/home/assets/6.html-f31143bd.js" as="script"><link rel="prefetch" href="/home/assets/index.html-d4d6df4d.js" as="script"><link rel="prefetch" href="/home/assets/index.html-b98c27b4.js" as="script"><link rel="prefetch" href="/home/assets/algorithms.html-f5b5ee0a.js" as="script"><link rel="prefetch" href="/home/assets/c__.html-05ab7a9e.js" as="script"><link rel="prefetch" href="/home/assets/graph.html-dab7b16e.js" as="script"><link rel="prefetch" href="/home/assets/leetcode.html-f105e9f1.js" as="script"><link rel="prefetch" href="/home/assets/other_tree.html-22fe33b0.js" as="script"><link rel="prefetch" href="/home/assets/sort_and_search.html-11f53bfb.js" as="script"><link rel="prefetch" href="/home/assets/string.html-e9db3916.js" as="script"><link rel="prefetch" href="/home/assets/tree.html-ec32110e.js" as="script"><link rel="prefetch" href="/home/assets/1.html-99884eac.js" as="script"><link rel="prefetch" href="/home/assets/10.html-75dc6e9d.js" as="script"><link rel="prefetch" href="/home/assets/11.html-44ed8d03.js" as="script"><link rel="prefetch" href="/home/assets/12.html-1cafae42.js" as="script"><link rel="prefetch" href="/home/assets/13.html-cf9e5046.js" as="script"><link rel="prefetch" href="/home/assets/14.html-513b431e.js" as="script"><link rel="prefetch" href="/home/assets/2.html-094a87ee.js" as="script"><link rel="prefetch" href="/home/assets/3.html-4a8b2796.js" as="script"><link rel="prefetch" href="/home/assets/4.html-1f39f3b9.js" as="script"><link rel="prefetch" href="/home/assets/5.html-e78784fc.js" as="script"><link rel="prefetch" href="/home/assets/6.html-cc4acb22.js" as="script"><link rel="prefetch" href="/home/assets/7.html-ff096a2a.js" as="script"><link rel="prefetch" href="/home/assets/8.html-14b4319a.js" as="script"><link rel="prefetch" href="/home/assets/9.html-f1fd1f24.js" as="script"><link rel="prefetch" href="/home/assets/index.html-47fde470.js" as="script"><link rel="prefetch" href="/home/assets/1.html-769a7684.js" as="script"><link rel="prefetch" href="/home/assets/2.html-594984b8.js" as="script"><link rel="prefetch" href="/home/assets/3.html-5ac058a8.js" as="script"><link rel="prefetch" href="/home/assets/index.html-8a655167.js" as="script"><link rel="prefetch" href="/home/assets/1.html-a99eaaf4.js" as="script"><link rel="prefetch" href="/home/assets/index.html-17ad9c14.js" as="script"><link rel="prefetch" href="/home/assets/1.html-039b4262.js" as="script"><link rel="prefetch" href="/home/assets/2.html-42769e2a.js" as="script"><link rel="prefetch" href="/home/assets/index.html-25191acb.js" as="script"><link rel="prefetch" href="/home/assets/index.html-bf41a08e.js" as="script"><link rel="prefetch" href="/home/assets/jwt.html-3b7c50b6.js" as="script"><link rel="prefetch" href="/home/assets/shiro.html-342768e3.js" as="script"><link rel="prefetch" href="/home/assets/index.html-5427bf36.js" as="script"><link rel="prefetch" href="/home/assets/nacos.html-9e867259.js" as="script"><link rel="prefetch" href="/home/assets/index.html-48e4d448.js" as="script"><link rel="prefetch" href="/home/assets/spring_annotation.html-9fe17a51.js" as="script"><link rel="prefetch" href="/home/assets/springboot.html-5ae0091a.js" as="script"><link rel="prefetch" href="/home/assets/springboot_base.html-e6d2a44d.js" as="script"><link rel="prefetch" href="/home/assets/index.html-1bcb2be9.js" as="script"><link rel="prefetch" href="/home/assets/docker_tutorial.html-4f5d0900.js" as="script"><link rel="prefetch" href="/home/assets/firewall_tutorial.html-a1c0f732.js" as="script"><link rel="prefetch" href="/home/assets/mysql_tutorial.html-4c6ba5d6.js" as="script"><link rel="prefetch" href="/home/assets/nginx_tutorial.html-93df5119.js" as="script"><link rel="prefetch" href="/home/assets/other_tutorial.html-c3d0505a.js" as="script"><link rel="prefetch" href="/home/assets/1.html-51f0ec55.js" as="script"><link rel="prefetch" href="/home/assets/2.html-a59bf622.js" as="script"><link rel="prefetch" href="/home/assets/index.html-b0e9f560.js" as="script"><link rel="prefetch" href="/home/assets/5.html-a4a0234f.js" as="script"><link rel="prefetch" href="/home/assets/6.html-d1f646bc.js" as="script"><link rel="prefetch" href="/home/assets/7.html-4bfc5de3.js" as="script"><link rel="prefetch" href="/home/assets/Mybatis.html-999b181b.js" as="script"><link rel="prefetch" href="/home/assets/index.html-3e3eac32.js" as="script"><link rel="prefetch" href="/home/assets/Spring.html-ebdaae63.js" as="script"><link rel="prefetch" href="/home/assets/SpringBoot.html-c1676d63.js" as="script"><link rel="prefetch" href="/home/assets/SpringMVC.html-7bf971fc.js" as="script"><link rel="prefetch" href="/home/assets/1.html-095f3a2d.js" as="script"><link rel="prefetch" href="/home/assets/2.html-820329b9.js" as="script"><link rel="prefetch" href="/home/assets/3.html-65fa04a9.js" as="script"><link rel="prefetch" href="/home/assets/4.html-6cc0fdbb.js" as="script"><link rel="prefetch" href="/home/assets/5.html-4382da55.js" as="script"><link rel="prefetch" href="/home/assets/index.html-2c443520.js" as="script"><link rel="prefetch" href="/home/assets/index.html-0a2a0106.js" as="script"><link rel="prefetch" href="/home/assets/less.html-26b18828.js" as="script"><link rel="prefetch" href="/home/assets/sass.html-e33a9ecf.js" as="script"><link rel="prefetch" href="/home/assets/1.html-e6ed9dbf.js" as="script"><link rel="prefetch" href="/home/assets/2.html-76ba2e41.js" as="script"><link rel="prefetch" href="/home/assets/index.html-202d5f4b.js" as="script"><link rel="prefetch" href="/home/assets/1.html-c051337a.js" as="script"><link rel="prefetch" href="/home/assets/2.html-c475ae33.js" as="script"><link rel="prefetch" href="/home/assets/index.html-7a9eb86e.js" as="script"><link rel="prefetch" href="/home/assets/1.html-2d63875b.js" as="script"><link rel="prefetch" href="/home/assets/2.html-96ffe2d7.js" as="script"><link rel="prefetch" href="/home/assets/3.html-164f28d8.js" as="script"><link rel="prefetch" href="/home/assets/4.html-770067b7.js" as="script"><link rel="prefetch" href="/home/assets/5.html-94e4a58f.js" as="script"><link rel="prefetch" href="/home/assets/6.html-5fbe2511.js" as="script"><link rel="prefetch" href="/home/assets/7.html-6aaf4692.js" as="script"><link rel="prefetch" href="/home/assets/8.html-6c442319.js" as="script"><link rel="prefetch" href="/home/assets/9.html-1a1241a0.js" as="script"><link rel="prefetch" href="/home/assets/index.html-ca14f1ca.js" as="script"><link rel="prefetch" href="/home/assets/new.html-f39ecd3a.js" as="script"><link rel="prefetch" href="/home/assets/1.html-f45e37f8.js" as="script"><link rel="prefetch" href="/home/assets/index.html-3b81aa58.js" as="script"><link rel="prefetch" href="/home/assets/index.html-3505c412.js" as="script"><link rel="prefetch" href="/home/assets/uniCloud.html-d6f4a4e6.js" as="script"><link rel="prefetch" href="/home/assets/uniTips.html-c522b2d1.js" as="script"><link rel="prefetch" href="/home/assets/1.html-3be78b60.js" as="script"><link rel="prefetch" href="/home/assets/index.html-6602172a.js" as="script"><link rel="prefetch" href="/home/assets/index.html-dcc009ab.js" as="script"><link rel="prefetch" href="/home/assets/api_tutorial.html-201e8b68.js" as="script"><link rel="prefetch" href="/home/assets/base_tutorial.html-553e9cd8.js" as="script"><link rel="prefetch" href="/home/assets/pinia.html-93944f84.js" as="script"><link rel="prefetch" href="/home/assets/vue2.html-396e5caf.js" as="script"><link rel="prefetch" href="/home/assets/vue3_1.html-a3f127a4.js" as="script"><link rel="prefetch" href="/home/assets/vue3_2.html-52a41818.js" as="script"><link rel="prefetch" href="/home/assets/1.html-6b5b0d34.js" as="script"><link rel="prefetch" href="/home/assets/index.html-f9a24ca8.js" as="script"><link rel="prefetch" href="/home/assets/index.html-994c7095.js" as="script"><link rel="prefetch" href="/home/assets/base_concept.html-8c9eb618.js" as="script"><link rel="prefetch" href="/home/assets/python_usage.html-6eb25c4d.js" as="script"><link rel="prefetch" href="/home/assets/pytorch_usage.html-12ebfb9e.js" as="script"><link rel="prefetch" href="/home/assets/index.html-35ebf264.js" as="script"><link rel="prefetch" href="/home/assets/gas_fee.html-ed17beee.js" as="script"><link rel="prefetch" href="/home/assets/monitoring.html-7dcd87e7.js" as="script"><link rel="prefetch" href="/home/assets/statedb_execute.html-39620858.js" as="script"><link rel="prefetch" href="/home/assets/23_Dec.html-b55b0d44.js" as="script"><link rel="prefetch" href="/home/assets/23_Nov.html-7f12af9c.js" as="script"><link rel="prefetch" href="/home/assets/24_Jan.html-aa29373f.js" as="script"><link rel="prefetch" href="/home/assets/index.html-cf670ace.js" as="script"><link rel="prefetch" href="/home/assets/index.html-e9115f16.js" as="script"><link rel="prefetch" href="/home/assets/compose.html-72dd1522.js" as="script"><link rel="prefetch" href="/home/assets/image_construct.html-803fa8bb.js" as="script"><link rel="prefetch" href="/home/assets/intro.html-c97d438d.js" as="script"><link rel="prefetch" href="/home/assets/framework.html-26732a5d.js" as="script"><link rel="prefetch" href="/home/assets/interview.html-c43e6b5a.js" as="script"><link rel="prefetch" href="/home/assets/javabase.html-4b7acc92.js" as="script"><link rel="prefetch" href="/home/assets/javacollection.html-7d0eec7c.js" as="script"><link rel="prefetch" href="/home/assets/javaio.html-2e0ce7a0.js" as="script"><link rel="prefetch" href="/home/assets/javajuc.html-e3adfcb3.js" as="script"><link rel="prefetch" href="/home/assets/project.html-ee5d4ecd.js" as="script"><link rel="prefetch" href="/home/assets/index.html-c00cd462.js" as="script"><link rel="prefetch" href="/home/assets/account.html-f2972d26.js" as="script"><link rel="prefetch" href="/home/assets/block.html-a9d64f7a.js" as="script"><link rel="prefetch" href="/home/assets/consensus.html-d4a4313d.js" as="script"><link rel="prefetch" href="/home/assets/contract.html-ebb9a32c.js" as="script"><link rel="prefetch" href="/home/assets/crypto_base.html-6226e31f.js" as="script"><link rel="prefetch" href="/home/assets/erc20.html-9175e857.js" as="script"><link rel="prefetch" href="/home/assets/ethereum_base.html-ed8afc4d.js" as="script"><link rel="prefetch" href="/home/assets/evm.html-c6aa4ef2.js" as="script"><link rel="prefetch" href="/home/assets/gas.html-7e483dbf.js" as="script"><link rel="prefetch" href="/home/assets/go_ethereum.html-7454bd3e.js" as="script"><link rel="prefetch" href="/home/assets/hd_wallet.html-3b70c8a3.js" as="script"><link rel="prefetch" href="/home/assets/jsonrpc.html-4b92012b.js" as="script"><link rel="prefetch" href="/home/assets/leveldb.html-f6dcddfb.js" as="script"><link rel="prefetch" href="/home/assets/mev.html-3b28f6dc.js" as="script"><link rel="prefetch" href="/home/assets/mpt.html-78685936.js" as="script"><link rel="prefetch" href="/home/assets/node_client.html-1945c0e1.js" as="script"><link rel="prefetch" href="/home/assets/rlp.html-c63951dd.js" as="script"><link rel="prefetch" href="/home/assets/statedb.html-57e0e0ee.js" as="script"><link rel="prefetch" href="/home/assets/transaction.html-ea80179c.js" as="script"><link rel="prefetch" href="/home/assets/index.html-737a4dbc.js" as="script"><link rel="prefetch" href="/home/assets/distributed.html-cb9755f7.js" as="script"><link rel="prefetch" href="/home/assets/gin.html-93f5f92b.js" as="script"><link rel="prefetch" href="/home/assets/gorm_1.html-c2cc8863.js" as="script"><link rel="prefetch" href="/home/assets/gorm_2.html-c9e371bb.js" as="script"><link rel="prefetch" href="/home/assets/goweb.html-dfefa78e.js" as="script"><link rel="prefetch" href="/home/assets/protobuf.html-46891574.js" as="script"><link rel="prefetch" href="/home/assets/rpc.html-2433bbc8.js" as="script"><link rel="prefetch" href="/home/assets/sse.html-86957496.js" as="script"><link rel="prefetch" href="/home/assets/test.html-0295cc69.js" as="script"><link rel="prefetch" href="/home/assets/websocket.html-2392370e.js" as="script"><link rel="prefetch" href="/home/assets/1.html-8f3c150c.js" as="script"><link rel="prefetch" href="/home/assets/2.html-35ec231b.js" as="script"><link rel="prefetch" href="/home/assets/3.html-5d7e2173.js" as="script"><link rel="prefetch" href="/home/assets/4.html-b019902a.js" as="script"><link rel="prefetch" href="/home/assets/index.html-dd915206.js" as="script"><link rel="prefetch" href="/home/assets/index.html-27666f68.js" as="script"><link rel="prefetch" href="/home/assets/dockerbase.html-359d1c8c.js" as="script"><link rel="prefetch" href="/home/assets/dockerutil.html-7ea89af6.js" as="script"><link rel="prefetch" href="/home/assets/k8sbase.html-dbb7e878.js" as="script"><link rel="prefetch" href="/home/assets/index.html-4918b69a.js" as="script"><link rel="prefetch" href="/home/assets/section0.html-0b462ef9.js" as="script"><link rel="prefetch" href="/home/assets/index.html-9e6553b4.js" as="script"><link rel="prefetch" href="/home/assets/mybatis.html-9fde4bbc.js" as="script"><link rel="prefetch" href="/home/assets/index.html-c33cb963.js" as="script"><link rel="prefetch" href="/home/assets/base.html-e757893c.js" as="script"><link rel="prefetch" href="/home/assets/progress_section_1.html-75bb5552.js" as="script"><link rel="prefetch" href="/home/assets/progress_section_2.html-042d6a61.js" as="script"><link rel="prefetch" href="/home/assets/progress_section_3.html-f33609b0.js" as="script"><link rel="prefetch" href="/home/assets/progress_section_4.html-979e5460.js" as="script"><link rel="prefetch" href="/home/assets/progress_section_5.html-e4a416a5.js" as="script"><link rel="prefetch" href="/home/assets/index.html-5b4a2fd2.js" as="script"><link rel="prefetch" href="/home/assets/alert.html-5d3a906c.js" as="script"><link rel="prefetch" href="/home/assets/clustering.html-1888741f.js" as="script"><link rel="prefetch" href="/home/assets/exporter.html-a7927412.js" as="script"><link rel="prefetch" href="/home/assets/intro.html-9b0b849c.js" as="script"><link rel="prefetch" href="/home/assets/promql.html-21c67535.js" as="script"><link rel="prefetch" href="/home/assets/servicediscovery.html-22fe93b7.js" as="script"><link rel="prefetch" href="/home/assets/index.html-5747b02b.js" as="script"><link rel="prefetch" href="/home/assets/base_usage.html-313edb82.js" as="script"><link rel="prefetch" href="/home/assets/1.html-84171baf.js" as="script"><link rel="prefetch" href="/home/assets/2.html-96474bc6.js" as="script"><link rel="prefetch" href="/home/assets/4.html-37db0907.js" as="script"><link rel="prefetch" href="/home/assets/index.html-9d407164.js" as="script"><link rel="prefetch" href="/home/assets/index.html-a2eab642.js" as="script"><link rel="prefetch" href="/home/assets/base.html-d1f2c2cd.js" as="script"><link rel="prefetch" href="/home/assets/progress.html-8a033067.js" as="script"><link rel="prefetch" href="/home/assets/script.html-15effd44.js" as="script"><link rel="prefetch" href="/home/assets/index.html-dbf7dd00.js" as="script"><link rel="prefetch" href="/home/assets/java_usage.html-baf8cd68.js" as="script"><link rel="prefetch" href="/home/assets/python_usage.html-5785b28e.js" as="script"><link rel="prefetch" href="/home/assets/system_usage.html-e9649787.js" as="script"><link rel="prefetch" href="/home/assets/404.html-f9875e7b.js" as="script"><link rel="prefetch" href="/home/assets/index.html-7783fe76.js" as="script"><link rel="prefetch" href="/home/assets/index.html-f1a44fda.js" as="script"><link rel="prefetch" href="/home/assets/index.html-4d8480ae.js" as="script"><link rel="prefetch" href="/home/assets/index.html-d4e8f589.js" as="script"><link rel="prefetch" href="/home/assets/index.html-de439329.js" as="script"><link rel="prefetch" href="/home/assets/1.html-b3dbe6c3.js" as="script"><link rel="prefetch" href="/home/assets/2.html-65dd00ed.js" as="script"><link rel="prefetch" href="/home/assets/3.html-be3dd68f.js" as="script"><link rel="prefetch" href="/home/assets/4.html-8c4bd084.js" as="script"><link rel="prefetch" href="/home/assets/5.html-f092cbbe.js" as="script"><link rel="prefetch" href="/home/assets/6.html-eb0b99a6.js" as="script"><link rel="prefetch" href="/home/assets/index.html-1610400f.js" as="script"><link rel="prefetch" href="/home/assets/index.html-fc997597.js" as="script"><link rel="prefetch" href="/home/assets/algorithms.html-792da975.js" as="script"><link rel="prefetch" href="/home/assets/c__.html-6601125c.js" as="script"><link rel="prefetch" href="/home/assets/graph.html-a85d7209.js" as="script"><link rel="prefetch" href="/home/assets/leetcode.html-89d11486.js" as="script"><link rel="prefetch" href="/home/assets/other_tree.html-6a93daa2.js" as="script"><link rel="prefetch" href="/home/assets/sort_and_search.html-d6ecd7d3.js" as="script"><link rel="prefetch" href="/home/assets/string.html-7dd849a6.js" as="script"><link rel="prefetch" href="/home/assets/tree.html-cc68ef7c.js" as="script"><link rel="prefetch" href="/home/assets/1.html-24b0066c.js" as="script"><link rel="prefetch" href="/home/assets/10.html-438f4b6e.js" as="script"><link rel="prefetch" href="/home/assets/11.html-4f1112c5.js" as="script"><link rel="prefetch" href="/home/assets/12.html-99ad4e1e.js" as="script"><link rel="prefetch" href="/home/assets/13.html-bf6f62cf.js" as="script"><link rel="prefetch" href="/home/assets/14.html-2a95fb67.js" as="script"><link rel="prefetch" href="/home/assets/2.html-ca8039ab.js" as="script"><link rel="prefetch" href="/home/assets/3.html-156faca2.js" as="script"><link rel="prefetch" href="/home/assets/4.html-fa3867a0.js" as="script"><link rel="prefetch" href="/home/assets/5.html-19069028.js" as="script"><link rel="prefetch" href="/home/assets/6.html-4bd37e04.js" as="script"><link rel="prefetch" href="/home/assets/7.html-eec87ddb.js" as="script"><link rel="prefetch" href="/home/assets/8.html-995c599d.js" as="script"><link rel="prefetch" href="/home/assets/9.html-52a4dc50.js" as="script"><link rel="prefetch" href="/home/assets/index.html-079f5119.js" as="script"><link rel="prefetch" href="/home/assets/1.html-45630a09.js" as="script"><link rel="prefetch" href="/home/assets/2.html-2ccd37e7.js" as="script"><link rel="prefetch" href="/home/assets/3.html-4bf73dfe.js" as="script"><link rel="prefetch" href="/home/assets/index.html-61018d12.js" as="script"><link rel="prefetch" href="/home/assets/1.html-43962779.js" as="script"><link rel="prefetch" href="/home/assets/index.html-8714ab1b.js" as="script"><link rel="prefetch" href="/home/assets/1.html-b6a49a97.js" as="script"><link rel="prefetch" href="/home/assets/2.html-9611ddb1.js" as="script"><link rel="prefetch" href="/home/assets/index.html-2c6014a4.js" as="script"><link rel="prefetch" href="/home/assets/index.html-1498794f.js" as="script"><link rel="prefetch" href="/home/assets/jwt.html-f8976420.js" as="script"><link rel="prefetch" href="/home/assets/shiro.html-2c64b104.js" as="script"><link rel="prefetch" href="/home/assets/index.html-731d0d4c.js" as="script"><link rel="prefetch" href="/home/assets/nacos.html-a8e1f880.js" as="script"><link rel="prefetch" href="/home/assets/index.html-6e89616b.js" as="script"><link rel="prefetch" href="/home/assets/spring_annotation.html-94151901.js" as="script"><link rel="prefetch" href="/home/assets/springboot.html-6b370acb.js" as="script"><link rel="prefetch" href="/home/assets/springboot_base.html-a67304ba.js" as="script"><link rel="prefetch" href="/home/assets/index.html-65b15a29.js" as="script"><link rel="prefetch" href="/home/assets/docker_tutorial.html-b6a29990.js" as="script"><link rel="prefetch" href="/home/assets/firewall_tutorial.html-b4cff9d1.js" as="script"><link rel="prefetch" href="/home/assets/mysql_tutorial.html-93d2d398.js" as="script"><link rel="prefetch" href="/home/assets/nginx_tutorial.html-6c2a4e2a.js" as="script"><link rel="prefetch" href="/home/assets/other_tutorial.html-3f91852e.js" as="script"><link rel="prefetch" href="/home/assets/1.html-72208351.js" as="script"><link rel="prefetch" href="/home/assets/2.html-385f7732.js" as="script"><link rel="prefetch" href="/home/assets/index.html-18206805.js" as="script"><link rel="prefetch" href="/home/assets/5.html-5130dec7.js" as="script"><link rel="prefetch" href="/home/assets/6.html-fc7318f6.js" as="script"><link rel="prefetch" href="/home/assets/7.html-7809fc9c.js" as="script"><link rel="prefetch" href="/home/assets/Mybatis.html-16063d38.js" as="script"><link rel="prefetch" href="/home/assets/index.html-6592d6ff.js" as="script"><link rel="prefetch" href="/home/assets/Spring.html-26618cb6.js" as="script"><link rel="prefetch" href="/home/assets/SpringBoot.html-e0688541.js" as="script"><link rel="prefetch" href="/home/assets/SpringMVC.html-b4418ab8.js" as="script"><link rel="prefetch" href="/home/assets/1.html-80b84ceb.js" as="script"><link rel="prefetch" href="/home/assets/2.html-d2e13b68.js" as="script"><link rel="prefetch" href="/home/assets/3.html-2ed8ce83.js" as="script"><link rel="prefetch" href="/home/assets/4.html-c38e359f.js" as="script"><link rel="prefetch" href="/home/assets/5.html-f49477c8.js" as="script"><link rel="prefetch" href="/home/assets/index.html-b015cbd2.js" as="script"><link rel="prefetch" href="/home/assets/index.html-8bfae031.js" as="script"><link rel="prefetch" href="/home/assets/less.html-42700d27.js" as="script"><link rel="prefetch" href="/home/assets/sass.html-d1b252a0.js" as="script"><link rel="prefetch" href="/home/assets/1.html-cad4a83b.js" as="script"><link rel="prefetch" href="/home/assets/2.html-2eb7e688.js" as="script"><link rel="prefetch" href="/home/assets/index.html-0d932819.js" as="script"><link rel="prefetch" href="/home/assets/1.html-ae1d7b24.js" as="script"><link rel="prefetch" href="/home/assets/2.html-ca217854.js" as="script"><link rel="prefetch" href="/home/assets/index.html-36cdeb1d.js" as="script"><link rel="prefetch" href="/home/assets/1.html-265e6c56.js" as="script"><link rel="prefetch" href="/home/assets/2.html-9cffb1c0.js" as="script"><link rel="prefetch" href="/home/assets/3.html-4c6a8226.js" as="script"><link rel="prefetch" href="/home/assets/4.html-18de9e19.js" as="script"><link rel="prefetch" href="/home/assets/5.html-4326ed53.js" as="script"><link rel="prefetch" href="/home/assets/6.html-fd4a800b.js" as="script"><link rel="prefetch" href="/home/assets/7.html-a9c2b9de.js" as="script"><link rel="prefetch" href="/home/assets/8.html-39395b19.js" as="script"><link rel="prefetch" href="/home/assets/9.html-b99383d5.js" as="script"><link rel="prefetch" href="/home/assets/index.html-06c37983.js" as="script"><link rel="prefetch" href="/home/assets/new.html-8b79afbd.js" as="script"><link rel="prefetch" href="/home/assets/1.html-b3d8878e.js" as="script"><link rel="prefetch" href="/home/assets/index.html-9221b0a5.js" as="script"><link rel="prefetch" href="/home/assets/index.html-214509a4.js" as="script"><link rel="prefetch" href="/home/assets/uniCloud.html-e9efbc8e.js" as="script"><link rel="prefetch" href="/home/assets/uniTips.html-82d7e645.js" as="script"><link rel="prefetch" href="/home/assets/1.html-c9f5f32c.js" as="script"><link rel="prefetch" href="/home/assets/index.html-0d8cbf9c.js" as="script"><link rel="prefetch" href="/home/assets/index.html-775640a2.js" as="script"><link rel="prefetch" href="/home/assets/api_tutorial.html-3d5aab1a.js" as="script"><link rel="prefetch" href="/home/assets/base_tutorial.html-c0a87c33.js" as="script"><link rel="prefetch" href="/home/assets/pinia.html-3c5a181d.js" as="script"><link rel="prefetch" href="/home/assets/vue2.html-eae4d9a2.js" as="script"><link rel="prefetch" href="/home/assets/vue3_1.html-54992761.js" as="script"><link rel="prefetch" href="/home/assets/vue3_2.html-c5dbb387.js" as="script"><link rel="prefetch" href="/home/assets/1.html-951ed96c.js" as="script"><link rel="prefetch" href="/home/assets/index.html-247966c3.js" as="script"><link rel="prefetch" href="/home/assets/index.html-8c14f29c.js" as="script"><link rel="prefetch" href="/home/assets/base_concept.html-ac8ce1d9.js" as="script"><link rel="prefetch" href="/home/assets/python_usage.html-0f79b1fe.js" as="script"><link rel="prefetch" href="/home/assets/pytorch_usage.html-74ba17da.js" as="script"><link rel="prefetch" href="/home/assets/index.html-5664dac2.js" as="script"><link rel="prefetch" href="/home/assets/gas_fee.html-842b80b5.js" as="script"><link rel="prefetch" href="/home/assets/monitoring.html-b169e00f.js" as="script"><link rel="prefetch" href="/home/assets/statedb_execute.html-be59784d.js" as="script"><link rel="prefetch" href="/home/assets/23_Dec.html-43a019a4.js" as="script"><link rel="prefetch" href="/home/assets/23_Nov.html-59eb7e15.js" as="script"><link rel="prefetch" href="/home/assets/24_Jan.html-f1adeaaf.js" as="script"><link rel="prefetch" href="/home/assets/index.html-a9fd55ce.js" as="script"><link rel="prefetch" href="/home/assets/index.html-4412c843.js" as="script"><link rel="prefetch" href="/home/assets/compose.html-f65d3f60.js" as="script"><link rel="prefetch" href="/home/assets/image_construct.html-cb4fdf2a.js" as="script"><link rel="prefetch" href="/home/assets/intro.html-f2059593.js" as="script"><link rel="prefetch" href="/home/assets/framework.html-b584b969.js" as="script"><link rel="prefetch" href="/home/assets/interview.html-8b316320.js" as="script"><link rel="prefetch" href="/home/assets/javabase.html-30185b2a.js" as="script"><link rel="prefetch" href="/home/assets/javacollection.html-cd80a1d4.js" as="script"><link rel="prefetch" href="/home/assets/javaio.html-69e52419.js" as="script"><link rel="prefetch" href="/home/assets/javajuc.html-67267a87.js" as="script"><link rel="prefetch" href="/home/assets/project.html-6dc9c93a.js" as="script"><link rel="prefetch" href="/home/assets/index.html-42352500.js" as="script"><link rel="prefetch" href="/home/assets/account.html-d37af6aa.js" as="script"><link rel="prefetch" href="/home/assets/block.html-d0b1c8ab.js" as="script"><link rel="prefetch" href="/home/assets/consensus.html-d465dd82.js" as="script"><link rel="prefetch" href="/home/assets/contract.html-dcaa70cb.js" as="script"><link rel="prefetch" href="/home/assets/crypto_base.html-c9dfea74.js" as="script"><link rel="prefetch" href="/home/assets/erc20.html-b68f5386.js" as="script"><link rel="prefetch" href="/home/assets/ethereum_base.html-51744323.js" as="script"><link rel="prefetch" href="/home/assets/evm.html-f0c26ba2.js" as="script"><link rel="prefetch" href="/home/assets/gas.html-df6fb49b.js" as="script"><link rel="prefetch" href="/home/assets/go_ethereum.html-2fae4c0d.js" as="script"><link rel="prefetch" href="/home/assets/hd_wallet.html-9e7f4b09.js" as="script"><link rel="prefetch" href="/home/assets/jsonrpc.html-b68ca6a4.js" as="script"><link rel="prefetch" href="/home/assets/leveldb.html-bfded8f6.js" as="script"><link rel="prefetch" href="/home/assets/mev.html-58e57642.js" as="script"><link rel="prefetch" href="/home/assets/mpt.html-df4ed851.js" as="script"><link rel="prefetch" href="/home/assets/node_client.html-d28b2c56.js" as="script"><link rel="prefetch" href="/home/assets/rlp.html-29fe07bb.js" as="script"><link rel="prefetch" href="/home/assets/statedb.html-39b67c02.js" as="script"><link rel="prefetch" href="/home/assets/transaction.html-9460adb0.js" as="script"><link rel="prefetch" href="/home/assets/index.html-dab46f0d.js" as="script"><link rel="prefetch" href="/home/assets/distributed.html-6f0dbbfe.js" as="script"><link rel="prefetch" href="/home/assets/gin.html-07268e87.js" as="script"><link rel="prefetch" href="/home/assets/gorm_1.html-7e8a1e41.js" as="script"><link rel="prefetch" href="/home/assets/gorm_2.html-90691088.js" as="script"><link rel="prefetch" href="/home/assets/goweb.html-57e4f4d6.js" as="script"><link rel="prefetch" href="/home/assets/protobuf.html-56c8543d.js" as="script"><link rel="prefetch" href="/home/assets/rpc.html-8e3550c5.js" as="script"><link rel="prefetch" href="/home/assets/sse.html-2e82fdbe.js" as="script"><link rel="prefetch" href="/home/assets/test.html-72f019e6.js" as="script"><link rel="prefetch" href="/home/assets/websocket.html-0aa6026e.js" as="script"><link rel="prefetch" href="/home/assets/1.html-e5914bc9.js" as="script"><link rel="prefetch" href="/home/assets/2.html-73780b7e.js" as="script"><link rel="prefetch" href="/home/assets/3.html-02752cb6.js" as="script"><link rel="prefetch" href="/home/assets/4.html-daaafb6e.js" as="script"><link rel="prefetch" href="/home/assets/index.html-01fe5aa5.js" as="script"><link rel="prefetch" href="/home/assets/index.html-1e6dd004.js" as="script"><link rel="prefetch" href="/home/assets/dockerbase.html-7e048fc7.js" as="script"><link rel="prefetch" href="/home/assets/dockerutil.html-83a56e01.js" as="script"><link rel="prefetch" href="/home/assets/k8sbase.html-5756d5f4.js" as="script"><link rel="prefetch" href="/home/assets/index.html-93b735fb.js" as="script"><link rel="prefetch" href="/home/assets/section0.html-347daa1a.js" as="script"><link rel="prefetch" href="/home/assets/index.html-a46204c7.js" as="script"><link rel="prefetch" href="/home/assets/mybatis.html-f56479d3.js" as="script"><link rel="prefetch" href="/home/assets/index.html-d72ca7a3.js" as="script"><link rel="prefetch" href="/home/assets/base.html-1f5622f8.js" as="script"><link rel="prefetch" href="/home/assets/progress_section_1.html-9eadcbcd.js" as="script"><link rel="prefetch" href="/home/assets/progress_section_2.html-a292ded6.js" as="script"><link rel="prefetch" href="/home/assets/progress_section_3.html-0243f2d5.js" as="script"><link rel="prefetch" href="/home/assets/progress_section_4.html-362920aa.js" as="script"><link rel="prefetch" href="/home/assets/progress_section_5.html-cc744949.js" as="script"><link rel="prefetch" href="/home/assets/index.html-8eef26bc.js" as="script"><link rel="prefetch" href="/home/assets/alert.html-df6aa47e.js" as="script"><link rel="prefetch" href="/home/assets/clustering.html-3b9dec8d.js" as="script"><link rel="prefetch" href="/home/assets/exporter.html-3fad2603.js" as="script"><link rel="prefetch" href="/home/assets/intro.html-952ab997.js" as="script"><link rel="prefetch" href="/home/assets/promql.html-5e9353dd.js" as="script"><link rel="prefetch" href="/home/assets/servicediscovery.html-e978116d.js" as="script"><link rel="prefetch" href="/home/assets/index.html-955d04ac.js" as="script"><link rel="prefetch" href="/home/assets/base_usage.html-11f1fd5d.js" as="script"><link rel="prefetch" href="/home/assets/1.html-5e65474e.js" as="script"><link rel="prefetch" href="/home/assets/2.html-9a518c05.js" as="script"><link rel="prefetch" href="/home/assets/4.html-afb43511.js" as="script"><link rel="prefetch" href="/home/assets/index.html-26f2cbca.js" as="script"><link rel="prefetch" href="/home/assets/index.html-23fc39d3.js" as="script"><link rel="prefetch" href="/home/assets/base.html-d939e2ab.js" as="script"><link rel="prefetch" href="/home/assets/progress.html-1cd56b38.js" as="script"><link rel="prefetch" href="/home/assets/script.html-157d9d5a.js" as="script"><link rel="prefetch" href="/home/assets/index.html-42bf5edf.js" as="script"><link rel="prefetch" href="/home/assets/java_usage.html-06a6ebb2.js" as="script"><link rel="prefetch" href="/home/assets/python_usage.html-e1ad0359.js" as="script"><link rel="prefetch" href="/home/assets/system_usage.html-a6f73a2f.js" as="script"><link rel="prefetch" href="/home/assets/404.html-7c09735e.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/home/" class=""><!----><span class="site-name">不愿飞的蜂鸟首页</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide"><!--[--><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="Five研究生"><span class="title">Five研究生</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="Five研究生"><span class="title">Five研究生</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>Block Chain Internship</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/home/master/ethereum/" class="" aria-label="ethereum"><!--[--><!--]--> ethereum <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/home/master/blockchaindevelopment/" class="" aria-label="block chain development"><!--[--><!--]--> block chain development <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/home/master/docker/" class="" aria-label="docker"><!--[--><!--]--> docker <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/home/master/golang/" class="" aria-label="golang"><!--[--><!--]--> golang <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/home/master/prometheus/" class="" aria-label="prometheus"><!--[--><!--]--> prometheus <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/home/master/shell/" class="" aria-label="shell"><!--[--><!--]--> shell <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>Java Engineering</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/home/master/redis/" class="router-link-active" aria-label="Redis"><!--[--><!--]--> Redis <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/home/master/mysql/" class="" aria-label="MySQL"><!--[--><!--]--> MySQL <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/home/master/jvm/" class="" aria-label="JVM"><!--[--><!--]--> JVM <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/home/master/mybatis/" class="" aria-label="MyBatis"><!--[--><!--]--> MyBatis <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>Deep Learning</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/home/master/ubuntu/" class="" aria-label="Ubuntu"><!--[--><!--]--> Ubuntu <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/home/master/GNN/" class="" aria-label="GNN"><!--[--><!--]--> GNN <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/home/master/python/" class="" aria-label="Python"><!--[--><!--]--> Python <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="Five本科"><span class="title">Five本科</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="Five本科"><span class="title">Five本科</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>foreground</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/home/tech/js/" class="" aria-label="JavaScript"><!--[--><!--]--> JavaScript <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/home/tech/typescript/" class="" aria-label="TypeScript"><!--[--><!--]--> TypeScript <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/home/tech/html_css/" class="" aria-label="HTML_CSS"><!--[--><!--]--> HTML_CSS <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/home/tech/less_sass/" class="" aria-label="Less_Sass"><!--[--><!--]--> Less_Sass <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/home/tech/react/" class="" aria-label="React"><!--[--><!--]--> React <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/home/tech/vue/" class="" aria-label="Vue"><!--[--><!--]--> Vue <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/home/tech/vite/" class="" aria-label="Vite"><!--[--><!--]--> Vite <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/home/tech/webpack/" class="" aria-label="Webpack"><!--[--><!--]--> Webpack <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>background</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/home/tech/java/" class="" aria-label="JAVA"><!--[--><!--]--> JAVA <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/home/tech/node/" class="" aria-label="Node"><!--[--><!--]--> Node <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>app.mp</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/home/tech/miniProgram/" class="" aria-label="MiniProgram"><!--[--><!--]--> MiniProgram <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/home/tech/uni-app/" class="" aria-label="uni-app"><!--[--><!--]--> uni-app <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>server</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/home/tech/centos/" class="" aria-label="Centos"><!--[--><!--]--> Centos <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="Five本科课程"><span class="title">Five本科课程</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="Five本科课程"><span class="title">Five本科课程</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/home/course/operating_system/" class="" aria-label="操作系统"><!--[--><!--]--> 操作系统 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/home/course/computer_network/" class="" aria-label="计算机网络技术"><!--[--><!--]--> 计算机网络技术 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/home/course/datastructure_and_algorithm/" class="" aria-label="数据结构和算法"><!--[--><!--]--> 数据结构和算法 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="Five杂学"><span class="title">Five杂学</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="Five杂学"><span class="title">Five杂学</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>Java Section</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/home/trivia/spring/" class="" aria-label="Spring"><!--[--><!--]--> Spring <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/home/trivia/juc/" class="" aria-label="JUC"><!--[--><!--]--> JUC <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/home/trivia/netty/" class="" aria-label="Netty"><!--[--><!--]--> Netty <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/home/trivia/security/" class="" aria-label="Security"><!--[--><!--]--> Security <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/home/trivia/service/" class="" aria-label="Service"><!--[--><!--]--> Service <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><!--]--></ul></div></div><div class="navbar-item"><a class="external-link" href="https://github.com/liushun-ing" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-color-mode-button" title="toggle color mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><form class="search-box" role="search"><input type="search" placeholder="Search" autocomplete="off" spellcheck="false" value><!----></form></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items"><!--[--><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="Five研究生"><span class="title">Five研究生</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="Five研究生"><span class="title">Five研究生</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>Block Chain Internship</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/home/master/ethereum/" class="" aria-label="ethereum"><!--[--><!--]--> ethereum <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/home/master/blockchaindevelopment/" class="" aria-label="block chain development"><!--[--><!--]--> block chain development <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/home/master/docker/" class="" aria-label="docker"><!--[--><!--]--> docker <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/home/master/golang/" class="" aria-label="golang"><!--[--><!--]--> golang <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/home/master/prometheus/" class="" aria-label="prometheus"><!--[--><!--]--> prometheus <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/home/master/shell/" class="" aria-label="shell"><!--[--><!--]--> shell <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>Java Engineering</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/home/master/redis/" class="router-link-active" aria-label="Redis"><!--[--><!--]--> Redis <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/home/master/mysql/" class="" aria-label="MySQL"><!--[--><!--]--> MySQL <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/home/master/jvm/" class="" aria-label="JVM"><!--[--><!--]--> JVM <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/home/master/mybatis/" class="" aria-label="MyBatis"><!--[--><!--]--> MyBatis <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>Deep Learning</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/home/master/ubuntu/" class="" aria-label="Ubuntu"><!--[--><!--]--> Ubuntu <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/home/master/GNN/" class="" aria-label="GNN"><!--[--><!--]--> GNN <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/home/master/python/" class="" aria-label="Python"><!--[--><!--]--> Python <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="Five本科"><span class="title">Five本科</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="Five本科"><span class="title">Five本科</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>foreground</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/home/tech/js/" class="" aria-label="JavaScript"><!--[--><!--]--> JavaScript <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/home/tech/typescript/" class="" aria-label="TypeScript"><!--[--><!--]--> TypeScript <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/home/tech/html_css/" class="" aria-label="HTML_CSS"><!--[--><!--]--> HTML_CSS <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/home/tech/less_sass/" class="" aria-label="Less_Sass"><!--[--><!--]--> Less_Sass <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/home/tech/react/" class="" aria-label="React"><!--[--><!--]--> React <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/home/tech/vue/" class="" aria-label="Vue"><!--[--><!--]--> Vue <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/home/tech/vite/" class="" aria-label="Vite"><!--[--><!--]--> Vite <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/home/tech/webpack/" class="" aria-label="Webpack"><!--[--><!--]--> Webpack <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>background</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/home/tech/java/" class="" aria-label="JAVA"><!--[--><!--]--> JAVA <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/home/tech/node/" class="" aria-label="Node"><!--[--><!--]--> Node <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>app.mp</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/home/tech/miniProgram/" class="" aria-label="MiniProgram"><!--[--><!--]--> MiniProgram <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/home/tech/uni-app/" class="" aria-label="uni-app"><!--[--><!--]--> uni-app <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>server</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/home/tech/centos/" class="" aria-label="Centos"><!--[--><!--]--> Centos <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="Five本科课程"><span class="title">Five本科课程</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="Five本科课程"><span class="title">Five本科课程</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/home/course/operating_system/" class="" aria-label="操作系统"><!--[--><!--]--> 操作系统 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/home/course/computer_network/" class="" aria-label="计算机网络技术"><!--[--><!--]--> 计算机网络技术 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/home/course/datastructure_and_algorithm/" class="" aria-label="数据结构和算法"><!--[--><!--]--> 数据结构和算法 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="Five杂学"><span class="title">Five杂学</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="Five杂学"><span class="title">Five杂学</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>Java Section</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/home/trivia/spring/" class="" aria-label="Spring"><!--[--><!--]--> Spring <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/home/trivia/juc/" class="" aria-label="JUC"><!--[--><!--]--> JUC <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/home/trivia/netty/" class="" aria-label="Netty"><!--[--><!--]--> Netty <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/home/trivia/security/" class="" aria-label="Security"><!--[--><!--]--> Security <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/home/trivia/service/" class="" aria-label="Service"><!--[--><!--]--> Service <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><!--]--></ul></div></div><div class="navbar-item"><a class="external-link" href="https://github.com/liushun-ing" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><p tabindex="0" class="sidebar-item sidebar-heading active">Redis <!----></p><ul style="" class="sidebar-item-children"><!--[--><li><a href="/home/master/redis/" class="router-link-active sidebar-item" aria-label="Navigation"><!--[--><!--]--> Navigation <!--[--><!--]--></a><!----></li><li><a href="/home/master/redis/1.html" class="sidebar-item" aria-label="Redis基础"><!--[--><!--]--> Redis基础 <!--[--><!--]--></a><!----></li><li><a href="/home/master/redis/2.html" class="sidebar-item" aria-label="Redis实战"><!--[--><!--]--> Redis实战 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/home/master/redis/3.html" class="router-link-active router-link-exact-active router-link-active sidebar-item active" aria-label="Redis高级"><!--[--><!--]--> Redis高级 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/home/master/redis/3.html#_0分布式缓存" class="router-link-active router-link-exact-active sidebar-item" aria-label="0分布式缓存"><!--[--><!--]--> 0分布式缓存 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/home/master/redis/3.html#_0-1-redis持久化" class="router-link-active router-link-exact-active sidebar-item" aria-label="0.1.Redis持久化"><!--[--><!--]--> 0.1.Redis持久化 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/home/master/redis/3.html#_0-2-redis主从" class="router-link-active router-link-exact-active sidebar-item" aria-label="0.2.Redis主从"><!--[--><!--]--> 0.2.Redis主从 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/home/master/redis/3.html#_0-3-redis哨兵" class="router-link-active router-link-exact-active sidebar-item" aria-label="0.3.Redis哨兵"><!--[--><!--]--> 0.3.Redis哨兵 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/home/master/redis/3.html#_0-4-redis分片集群" class="router-link-active router-link-exact-active sidebar-item" aria-label="0.4.Redis分片集群"><!--[--><!--]--> 0.4.Redis分片集群 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/home/master/redis/3.html#_1-多级缓存" class="router-link-active router-link-exact-active sidebar-item" aria-label="1.多级缓存"><!--[--><!--]--> 1.多级缓存 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/home/master/redis/3.html#_1-1-jvm进程缓存" class="router-link-active router-link-exact-active sidebar-item" aria-label="1.1.JVM进程缓存"><!--[--><!--]--> 1.1.JVM进程缓存 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/home/master/redis/3.html#_1-2-lua入门" class="router-link-active router-link-exact-active sidebar-item" aria-label="1.2.Lua入门"><!--[--><!--]--> 1.2.Lua入门 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/home/master/redis/3.html#_1-3-实现多级缓存" class="router-link-active router-link-exact-active sidebar-item" aria-label="1.3.实现多级缓存"><!--[--><!--]--> 1.3.实现多级缓存 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/home/master/redis/3.html#_1-4-数据同步策略" class="router-link-active router-link-exact-active sidebar-item" aria-label="1.4.数据同步策略"><!--[--><!--]--> 1.4.数据同步策略 <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul></li><li><a href="/home/master/redis/4.html" class="sidebar-item" aria-label="Redis原理"><!--[--><!--]--> Redis原理 <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><!--]--><div><h1 id="redis高级" tabindex="-1"><a class="header-anchor" href="#redis高级" aria-hidden="true">#</a> Redis高级</h1><h2 id="_0分布式缓存" tabindex="-1"><a class="header-anchor" href="#_0分布式缓存" aria-hidden="true">#</a> 0分布式缓存</h2><p>单机的Redis存在四大问题：</p><img src="/home/assets/image-20210725144240631-7098511e.png" alt="image-20210725144240631" style="zoom:50%;"><h3 id="_0-1-redis持久化" tabindex="-1"><a class="header-anchor" href="#_0-1-redis持久化" aria-hidden="true">#</a> 0.1.Redis持久化</h3><p>Redis有两种持久化方案：</p><ul><li>RDB持久化</li><li>AOF持久化</li></ul><h4 id="rdb持久化" tabindex="-1"><a class="header-anchor" href="#rdb持久化" aria-hidden="true">#</a> RDB持久化</h4><p>RDB全称Redis Database Backup file（Redis数据备份文件），也被叫做Redis数据快照。简单来说就是把内存中的所有数据都记录到磁盘中。当Redis实例故障重启后，从磁盘读取快照文件，恢复数据。快照文件称为RDB文件，默认是保存在当前运行目录。</p><h5 id="执行时机" tabindex="-1"><a class="header-anchor" href="#执行时机" aria-hidden="true">#</a> 执行时机</h5><p>RDB持久化在四种情况下会执行：</p><ul><li>执行save命令</li><li>执行bgsave命令</li><li>Redis停机时</li><li>触发RDB条件时</li></ul><p><strong>1）save命令</strong></p><p>执行下面的命令，可以立即执行一次RDB：</p><img src="/home/assets/image-20210725144536958-981d82c0.png" alt="image-20210725144536958" style="zoom:33%;"><p>save命令会导致主进程执行RDB，这个过程中其它所有命令都会被阻塞。只有在数据迁移时可能用到。</p><p><strong>2）bgsave命令</strong></p><p>下面的命令可以异步执行RDB：</p><img src="/home/assets/image-20210725144725943-25f555fc.png" alt="image-20210725144725943" style="zoom:33%;"><p>这个命令执行后会开启独立进程完成RDB，主进程可以持续处理用户请求，不受影响。</p><p><strong>3）停机时</strong></p><p>Redis停机时会执行一次save命令，实现RDB持久化。</p><p><strong>4）触发RDB条件</strong></p><p>Redis内部有触发RDB的机制，可以在redis.conf文件中找到，格式如下：</p><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token comment"># 900秒内，如果至少有1个key被修改，则执行bgsave ， 如果是save &quot;&quot; 则表示禁用RDB</span>
<span class="token key attr-name">save</span> <span class="token value attr-value">900 1  </span>
<span class="token key attr-name">save</span> <span class="token value attr-value">300 10  </span>
<span class="token key attr-name">save</span> <span class="token value attr-value">60 10000 </span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>RDB的其它配置也可以在redis.conf文件中设置：</p><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token comment"># 是否压缩 ,建议不开启，压缩也会消耗cpu，磁盘的话不值钱</span>
<span class="token key attr-name">rdbcompression</span> <span class="token value attr-value">yes</span>
<span class="token comment"># RDB文件名称</span>
<span class="token key attr-name">dbfilename</span> <span class="token value attr-value">dump.rdb  </span>
<span class="token comment"># 文件保存的路径目录</span>
<span class="token key attr-name">dir</span> <span class="token value attr-value">./ </span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="rdb原理" tabindex="-1"><a class="header-anchor" href="#rdb原理" aria-hidden="true">#</a> RDB原理</h5><p>bgsave开始时会fork主进程得到子进程，子进程共享主进程的内存数据。完成fork后读取内存数据并写入 RDB 文件。</p><p>fork采用的是copy-on-write技术：</p><ul><li>当主进程执行读操作时，访问共享内存；</li><li>当主进程执行写操作时，则会拷贝一份数据，执行写操作。</li></ul><img src="/home/assets/image-20210725151319695-ac3eab79.png" alt="image-20210725151319695" style="zoom:33%;"><h5 id="小结" tabindex="-1"><a class="header-anchor" href="#小结" aria-hidden="true">#</a> 小结</h5><p>RDB方式bgsave的基本流程？</p><ul><li>fork主进程得到一个子进程，共享内存空间</li><li>子进程读取内存数据并写入新的RDB文件</li><li>用新RDB文件替换旧的RDB文件</li></ul><p>RDB会在什么时候执行？save 60 1000代表什么含义？</p><ul><li>默认是服务停止时</li><li>代表60秒内至少执行1000次修改则触发RDB</li></ul><p>RDB的缺点？</p><ul><li>RDB执行间隔时间长，两次RDB之间写入数据有丢失的风险</li><li>fork子进程、压缩、写出RDB文件都比较耗时</li></ul><h4 id="aof持久化" tabindex="-1"><a class="header-anchor" href="#aof持久化" aria-hidden="true">#</a> AOF持久化</h4><h5 id="aof原理" tabindex="-1"><a class="header-anchor" href="#aof原理" aria-hidden="true">#</a> AOF原理</h5><p>AOF全称为Append Only File（追加文件）。Redis处理的每一个写命令都会记录在AOF文件，可以看做是命令日志文件。</p><h5 id="aof配置" tabindex="-1"><a class="header-anchor" href="#aof配置" aria-hidden="true">#</a> AOF配置</h5><p>AOF默认是关闭的，需要修改redis.conf配置文件来开启AOF：</p><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token comment"># 是否开启AOF功能，默认是no</span>
<span class="token key attr-name">appendonly</span> <span class="token value attr-value">yes</span>
<span class="token comment"># AOF文件的名称</span>
<span class="token key attr-name">appendfilename</span> <span class="token value attr-value">&quot;appendonly.aof&quot;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>AOF的命令记录的频率也可以通过redis.conf文件来配：</p><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token comment"># 表示每执行一次写命令，立即记录到AOF文件</span>
<span class="token key attr-name">appendfsync</span> <span class="token value attr-value">always </span>
<span class="token comment"># 写命令执行完先放入AOF缓冲区，然后表示每隔1秒将缓冲区数据写到AOF文件，是默认方案</span>
<span class="token key attr-name">appendfsync</span> <span class="token value attr-value">everysec </span>
<span class="token comment"># 写命令执行完先放入AOF缓冲区，由操作系统决定何时将缓冲区内容写回磁盘</span>
<span class="token key attr-name">appendfsync</span> <span class="token value attr-value">no</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>三种策略对比：</p><p><img src="/home/assets/image-20210725151654046-f9697d10.png" alt="image-20210725151654046"></p><h5 id="aof文件重写" tabindex="-1"><a class="header-anchor" href="#aof文件重写" aria-hidden="true">#</a> AOF文件重写</h5><p>因为是记录命令，AOF文件会比RDB文件大的多。而且AOF会记录对同一个key的多次写操作，但只有最后一次写操作才有意义。通过执行bgrewriteaof命令，可以让AOF文件执行重写功能，用最少的命令达到相同效果。</p><img src="/home/assets/image-20210725151729118-d827d93a.png" alt="image-20210725151729118" style="zoom:50%;"><p>Redis也会在触发阈值时自动去重写AOF文件。阈值也可以在redis.conf中配置：</p><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token comment"># AOF文件比上次文件 增长超过多少百分比则触发重写</span>
<span class="token key attr-name">auto-aof-rewrite-percentage</span> <span class="token value attr-value">100</span>
<span class="token comment"># AOF文件体积最小多大以上才触发重写 </span>
<span class="token key attr-name">auto-aof-rewrite-min-size</span> <span class="token value attr-value">64mb </span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="rdb与aof对比" tabindex="-1"><a class="header-anchor" href="#rdb与aof对比" aria-hidden="true">#</a> RDB与AOF对比</h4><p>RDB和AOF各有自己的优缺点，如果对数据安全性要求较高，在实际开发中往往会<strong>结合</strong>两者来使用。</p><img src="/home/assets/image-20210725151940515-33dd1bef.png" alt="image-20210725151940515" style="zoom:50%;"><h3 id="_0-2-redis主从" tabindex="-1"><a class="header-anchor" href="#_0-2-redis主从" aria-hidden="true">#</a> 0.2.Redis主从</h3><h4 id="搭建" tabindex="-1"><a class="header-anchor" href="#搭建" aria-hidden="true">#</a> 搭建</h4><img src="/home/assets/image-20240228130626567-36202b4d.png" alt="image-20240228130626567" style="zoom:33%;"><p>新建三个文件夹，然后复制三份配置文件，修改配置文件的内容</p><p>修改每个文件夹内的配置文件，将端口分别修改为7001、7002、7003，将rdb文件保存位置都修改为自己所在目录；修改每个实例的声明IP，在redis.conf文件中指定每一个实例的绑定ip信息，格式如下：</p><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token comment"># redis实例的声明 IP</span>
<span class="token key attr-name">replica-announce-ip</span> <span class="token value attr-value">192.168.150.101</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>启动，打开3个ssh窗口，分别启动3个redis实例，启动命令：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 第1个</span>
redis-server 700x/redis.conf
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>开启主从关系</p><p>现在三个实例还没有任何关系，要配置主从可以使用replicaof 或者slaveof（5.0以前）命令。</p><p>有临时和永久两种模式：</p><ul><li><p>修改配置文件（永久生效）</p><ul><li>在redis.conf中添加一行配置：<code>slaveof &lt;masterip&gt; &lt;masterport&gt;</code></li></ul></li><li><p>使用redis-cli客户端连接到redis服务，执行slaveof命令（重启后失效）：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>slaveof <span class="token operator">&lt;</span>masterip<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>masterport<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li></ul><p><strong><!----></strong>：在5.0以后新增命令replicaof，与salveof效果一致。</p><p>通过redis-cli命令连接7002，执行下面命令：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 连接 7002</span>
redis-cli <span class="token parameter variable">-p</span> <span class="token number">7002</span>
<span class="token comment"># 执行slaveof</span>
slaveof <span class="token number">192.168</span>.150.101 <span class="token number">7001</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>然后连接 7001节点，查看集群状态：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 连接 7001</span>
redis-cli <span class="token parameter variable">-p</span> <span class="token number">7001</span>
<span class="token comment"># 查看状态</span>
info replication
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>结果：</p><img src="/home/assets/image-20210630201258802-0e593f2f.png" alt="image-20210630201258802" style="zoom:50%;"><h4 id="主从数据同步原理" tabindex="-1"><a class="header-anchor" href="#主从数据同步原理" aria-hidden="true">#</a> 主从数据同步原理</h4><h5 id="全量同步" tabindex="-1"><a class="header-anchor" href="#全量同步" aria-hidden="true">#</a> 全量同步</h5><p>主从第一次建立连接时，会执行<strong>全量同步</strong>，将master节点的所有数据都拷贝给slave节点，流程：</p><img src="/home/assets/image-20210725152222497-d2223f19.png" alt="image-20210725152222497" style="zoom:50%;"><p>master得知salve第一次连接判断依据：</p><ul><li><strong>Replication Id</strong>：简称replid，是数据集的标记，id一致则说明是同一数据集。每一个master都有唯一的replid，slave则会继承master节点的replid</li><li><strong>offset</strong>：偏移量，随着记录在repl_baklog中的数据增多而逐渐增大。slave完成同步时也会记录当前同步的offset。如果slave的offset小于master的offset，说明slave数据落后于master，需要更新。</li></ul><p>因此slave做数据同步，必须向master声明自己的replication id 和offset，master才可以判断到底需要同步哪些数据。</p><p>因为slave原本也是一个master，有自己的replid和offset，当第一次变成slave，与master建立连接时，发送的replid和offset是自己的replid和offset。</p><p>master判断发现slave发送来的replid与自己的不一致，说明这是一个全新的slave，就知道要做全量同步了。</p><p>master会将自己的replid和offset都发送给这个slave，slave保存这些信息。以后slave的replid就与master一致了。</p><p>因此，<strong>master判断一个节点是否是第一次同步的依据，就是看replid是否一致</strong>。</p><p>如图：</p><img src="/home/assets/image-20210725152700914-0d6d2065.png" alt="image-20210725152700914" style="zoom:50%;"><h5 id="增量同步" tabindex="-1"><a class="header-anchor" href="#增量同步" aria-hidden="true">#</a> 增量同步</h5><p>全量同步需要先做RDB，然后将RDB文件通过网络传输个slave，成本太高。因此除了第一次做全量同步，其它大多数时候slave与master都是做<strong>增量同步</strong>。</p><p>什么是增量同步？就是只更新slave与master存在差异的部分数据。如图：</p><img src="/home/assets/image-20210725153201086-ba535b71.png" alt="image-20210725153201086" style="zoom:50%;"><h5 id="repl-backlog原理" tabindex="-1"><a class="header-anchor" href="#repl-backlog原理" aria-hidden="true">#</a> repl_backlog原理</h5><p>这个文件是一个固定大小的数组，只不过数组是环形，也就是说<strong>角标到达数组末尾后，会再次从0开始读写</strong>，这样数组头部的数据就会被覆盖。</p><p>repl_baklog中会记录Redis处理过的命令日志及offset，包括master当前的offset，和slave已经拷贝到的offset：</p><img src="/home/assets/image-20210725153359022-435875fd.png" alt="image-20210725153359022" style="zoom:50%;"><p>slave与master的offset之间的差异，就是salve需要增量拷贝的数据。</p><p>但是，如果slave出现网络阻塞，导致master的offset远远超过了slave的offset，master继续写入新数据，其offset就会覆盖旧的数据，直到将slave现在的offset也覆盖：</p><img src="/home/assets/image-20210725154155984-9ebea34f.png" alt="image-20210725154155984" style="zoom:50%;"><p>此时如果slave恢复，需要同步，却发现自己的offset都没有了，无法完成增量同步了。只能做全量同步。</p><p><img src="/home/assets/image-20210725154216392-9b347241.png" alt="image-20210725154216392"></p><h5 id="主从同步优化" tabindex="-1"><a class="header-anchor" href="#主从同步优化" aria-hidden="true">#</a> 主从同步优化</h5><p>可以从以下几个方面来优化Redis主从就集群：</p><ul><li>在master中配置repl-diskless-sync yes启用无磁盘复制，避免全量同步时的磁盘IO。</li><li>Redis单节点上的内存占用不要太大，减少RDB导致的过多磁盘IO</li><li>适当提高repl_baklog的大小，发现slave宕机时尽快实现故障恢复，尽可能避免全量同步</li><li>限制一个master上的slave节点数量，如果实在是太多slave，则可以采用主-从-从链式结构，减少master压力</li></ul><p>主从从架构图：</p><img src="/home/assets/image-20210725154405899-841f6635.png" alt="image-20210725154405899" style="zoom:33%;"><h5 id="小结-1" tabindex="-1"><a class="header-anchor" href="#小结-1" aria-hidden="true">#</a> 小结</h5><p>简述全量同步和增量同步区别？</p><ul><li>全量同步：master将完整内存数据生成RDB，发送RDB到slave。后续命令则记录在repl_baklog，逐个发送给slave。</li><li>增量同步：slave提交自己的offset到master，master获取repl_baklog中从offset之后的命令给slave</li></ul><p>什么时候执行全量同步？</p><ul><li>slave节点第一次连接master节点时</li><li>slave节点断开时间太久，repl_baklog中的offset已经被覆盖时</li></ul><p>什么时候执行增量同步？</p><ul><li>slave节点断开又恢复，并且在repl_baklog中能找到offset时</li></ul><h3 id="_0-3-redis哨兵" tabindex="-1"><a class="header-anchor" href="#_0-3-redis哨兵" aria-hidden="true">#</a> 0.3.Redis哨兵</h3><p>Redis提供了哨兵（Sentinel）机制来实现主从集群的自动故障恢复。</p><h4 id="哨兵原理" tabindex="-1"><a class="header-anchor" href="#哨兵原理" aria-hidden="true">#</a> 哨兵原理</h4><h5 id="集群结构和作用" tabindex="-1"><a class="header-anchor" href="#集群结构和作用" aria-hidden="true">#</a> 集群结构和作用</h5><p>哨兵的结构如图：</p><img src="/home/assets/image-20210725154528072-0ba9baca.png" alt="image-20210725154528072" style="zoom:33%;"><p>哨兵的作用如下：</p><ul><li><strong>监控</strong>：Sentinel 会不断检查您的master和slave是否按预期工作</li><li><strong>自动故障恢复</strong>：如果master故障，Sentinel会将一个slave提升为master。当故障实例恢复后也以新的master为主</li><li><strong>通知</strong>：Sentinel充当Redis客户端的服务发现来源，当集群发生故障转移时，会将最新信息推送给Redis的客户端</li></ul><h5 id="集群监控原理" tabindex="-1"><a class="header-anchor" href="#集群监控原理" aria-hidden="true">#</a> 集群监控原理</h5><p>Sentinel基于心跳机制监测服务状态，每隔1秒向集群的每个实例发送ping命令：</p><p>•主观下线：如果某sentinel节点发现某实例未在规定时间响应，则认为该实例<strong>主观下线</strong>。</p><p>•客观下线：若超过指定数量（quorum）的sentinel都认为该实例主观下线，则该实例<strong>客观下线</strong>。quorum值最好超过Sentinel实例数量的一半。</p><h5 id="集群故障恢复原理" tabindex="-1"><a class="header-anchor" href="#集群故障恢复原理" aria-hidden="true">#</a> 集群故障恢复原理</h5><p>一旦发现master故障，sentinel需要在salve中选择一个作为新的master，选择依据是这样的：</p><ul><li>首先会判断slave节点与master节点断开时间长短，如果超过指定值（down-after-milliseconds * 10）则会排除该slave节点</li><li>然后判断slave节点的slave-priority值，越小优先级越高，如果是0则永不参与选举</li><li>如果slave-prority一样，则判断slave节点的offset值，越大说明数据越新，优先级越高</li><li>最后是判断slave节点的运行id大小，越小优先级越高。</li></ul><p>当选出一个新的master后，该如何实现切换呢？</p><p>流程如下：</p><ul><li>sentinel给备选的slave1节点发送slaveof no one命令，让该节点成为master</li><li>sentinel给所有其它slave发送slaveof 192.168.150.101 7002 命令，让这些slave成为新master的从节点，开始从新的master上同步数据。</li><li>最后，sentinel将故障节点标记为slave（直接修改配置文件），当故障节点恢复后会自动成为新的master的slave节点</li></ul><h5 id="小结-2" tabindex="-1"><a class="header-anchor" href="#小结-2" aria-hidden="true">#</a> 小结</h5><p>Sentinel的三个作用是什么？</p><ul><li>监控</li><li>故障转移</li><li>通知</li></ul><p>Sentinel如何判断一个redis实例是否健康？</p><ul><li>每隔1秒发送一次ping命令，如果超过一定时间没有相向则认为是主观下线</li><li>如果大多数sentinel都认为实例主观下线，则判定服务下线</li></ul><p>故障转移步骤有哪些？</p><ul><li>首先选定一个slave作为新的master，执行slaveof no one</li><li>然后让所有节点都执行slaveof 新master</li><li>修改故障节点配置，添加slaveof 新master</li></ul><h5 id="搭建-1" tabindex="-1"><a class="header-anchor" href="#搭建-1" aria-hidden="true">#</a> 搭建</h5><p>创建三个文件夹，分别创建三个配置文件sentinel.conf，添加下面的内容（port和dir要对应修改）：</p><div class="language-ini line-numbers-mode" data-ext="ini"><pre class="language-ini"><code>port 27001
sentinel announce-ip 192.168.150.101
sentinel monitor mymaster 192.168.150.101 7001 2
sentinel down-after-milliseconds mymaster 5000
sentinel failover-timeout mymaster 60000
dir &quot;/tmp/s1&quot;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>port 27001</code>：是当前sentinel实例的端口</li><li><code>sentinel monitor mymaster 192.168.150.101 7001 2</code>：指定主节点信息 <ul><li><code>mymaster</code>：主节点名称，自定义，任意写</li><li><code>192.168.150.101 7001</code>：主节点的ip和端口</li><li><code>2</code>：选举master时的quorum值</li></ul></li></ul><p>启动</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 第1个</span>
redis-sentinel s1/sentinel.conf
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_0-4-redis分片集群" tabindex="-1"><a class="header-anchor" href="#_0-4-redis分片集群" aria-hidden="true">#</a> 0.4.Redis分片集群</h3><h4 id="搭建分片集群" tabindex="-1"><a class="header-anchor" href="#搭建分片集群" aria-hidden="true">#</a> 搭建分片集群</h4><p>主从和哨兵可以解决高可用、高并发读的问题。但是依然有两个问题没有解决：</p><ul><li><p>海量数据存储问题</p></li><li><p>高并发写的问题</p></li></ul><p>使用分片集群可以解决上述问题，如图:</p><img src="/home/assets/image-20210725155747294-ed902a02.png" alt="image-20210725155747294" style="zoom:50%;"><p>分片集群特征：</p><ul><li><p>集群中有多个master，每个master保存不同数据</p></li><li><p>每个master都可以有多个slave节点</p></li><li><p>master之间通过ping监测彼此健康状态</p></li><li><p>客户端请求可以访问集群任意节点，最终都会被转发到正确节点</p></li></ul><blockquote><p>创建</p></blockquote><p>创建6个文件夹以及配置文件(实例不同，配置文件需要相应修改)</p><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token key attr-name">port</span> <span class="token value attr-value">6379</span>
<span class="token comment"># 开启集群功能</span>
<span class="token key attr-name">cluster-enabled</span> <span class="token value attr-value">yes</span>
<span class="token comment"># 集群的配置文件名称，不需要我们创建，由redis自己维护</span>
<span class="token key attr-name">cluster-config-file</span> <span class="token value attr-value">/tmp/6379/nodes.conf</span>
<span class="token comment"># 节点心跳失败的超时时间</span>
<span class="token key attr-name">cluster-node-timeout</span> <span class="token value attr-value">5000</span>
<span class="token comment"># 持久化文件存放目录</span>
<span class="token key attr-name">dir</span> <span class="token value attr-value">/tmp/6379</span>
<span class="token comment"># 绑定地址</span>
<span class="token key attr-name">bind</span> <span class="token value attr-value">0.0.0.0</span>
<span class="token comment"># 让redis后台运行</span>
<span class="token key attr-name">daemonize</span> <span class="token value attr-value">yes</span>
<span class="token comment"># 注册的实例ip</span>
<span class="token key attr-name">replica-announce-ip</span> <span class="token value attr-value">192.168.150.101</span>
<span class="token comment"># 保护模式</span>
<span class="token key attr-name">protected-mode</span> <span class="token value attr-value">no</span>
<span class="token comment"># 数据库数量</span>
<span class="token key attr-name">databases</span> <span class="token value attr-value">1</span>
<span class="token comment"># 日志</span>
<span class="token key attr-name">logfile</span> <span class="token value attr-value">/tmp/6379/run.log</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>一键启动所有服务</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 一键启动所有服务</span>
<span class="token builtin class-name">printf</span> <span class="token string">&#39;%s\n&#39;</span> <span class="token number">7001</span> <span class="token number">7002</span> <span class="token number">7003</span> <span class="token number">8001</span> <span class="token number">8002</span> <span class="token number">8003</span> <span class="token operator">|</span> <span class="token function">xargs</span> -I<span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token parameter variable">-t</span> redis-server <span class="token punctuation">{</span><span class="token punctuation">}</span>/redis.conf
<span class="token comment"># 一键关闭</span>
<span class="token builtin class-name">printf</span> <span class="token string">&#39;%s\n&#39;</span> <span class="token number">7001</span> <span class="token number">7002</span> <span class="token number">7003</span> <span class="token number">8001</span> <span class="token number">8002</span> <span class="token number">8003</span> <span class="token operator">|</span> <span class="token function">xargs</span> -I<span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token parameter variable">-t</span> redis-cli <span class="token parameter variable">-p</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token function">shutdown</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Redis6.2.4版本，集群管理以及集成到了redis-cli中，格式如下：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>redis-cli <span class="token parameter variable">--cluster</span> create --cluster-replicas <span class="token number">1</span> <span class="token number">192.168</span>.150.101:7001 <span class="token number">192.168</span>.150.101:7002 <span class="token number">192.168</span>.150.101:7003 <span class="token number">192.168</span>.150.101:8001 <span class="token number">192.168</span>.150.101:8002 <span class="token number">192.168</span>.150.101:8003
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>命令说明：</p><ul><li><code>redis-cli --cluster</code>或者<code>./redis-trib.rb</code>：代表集群操作命令</li><li><code>create</code>：代表是创建集群</li><li><code>--replicas 1</code>或者<code>--cluster-replicas 1</code> ：指定集群中每个master的副本个数为1，此时<code>节点总数 ÷ (replicas + 1)</code> 得到的就是master的数量。因此节点列表中的前n个就是master，其它节点都是slave节点，随机分配到不同master</li></ul><p>运行后的样子：</p><img src="/home/assets/image-20210702181101969-04b19dc2.png" alt="image-20210702181101969" style="zoom:33%;"><p>这里输入yes，则集群开始创建：</p><img src="/home/assets/image-20210702181215705-2c240f05.png" alt="image-20210702181215705" style="zoom:33%;"><p>通过命令可以查看集群状态：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>redis-cli <span class="token parameter variable">-p</span> <span class="token number">7001</span> cluster nodes
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><img src="/home/assets/image-20210702181922809-e5b841a4.png" alt="image-20210702181922809"></p><p>集群操作时，需要给<code>redis-cli</code>加上<code>-c</code>参数才可以：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>redis-cli <span class="token parameter variable">-c</span> <span class="token parameter variable">-p</span> <span class="token number">7001</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><img src="/home/assets/image-20210702182602145-c1a7a399.png" alt="image-20210702182602145" style="zoom:50%;"><h4 id="散列插槽" tabindex="-1"><a class="header-anchor" href="#散列插槽" aria-hidden="true">#</a> 散列插槽</h4><h5 id="插槽原理" tabindex="-1"><a class="header-anchor" href="#插槽原理" aria-hidden="true">#</a> 插槽原理</h5><p>Redis会把每一个master节点映射到0~16383共16384个插槽（hash slot）上，查看集群信息时就能看到：</p><img src="/home/assets/image-20210725155820320-9f23e1bb.png" alt="image-20210725155820320" style="zoom:67%;"><p>数据key不是与节点绑定，而是与插槽绑定。redis会根据key的有效部分计算插槽值，分两种情况：</p><ul><li>key中包含&quot;{}&quot;，且“{}”中至少包含1个字符，“{}”中的部分是有效部分</li><li>key中不包含“{}”，整个key都是有效部分</li></ul><p>例如：key是num，那么就根据num计算，如果是{itcast}num，则根据itcast计算。计算方式是利用CRC16算法得到一个hash值，然后对16384取余，得到的结果就是slot值。</p><img src="/home/assets/image-20210725155850200-799238af.png" alt="image-20210725155850200" style="zoom:67%;"><p>如图，在7001这个节点执行set a 1时，对a做hash运算，对16384取余，得到的结果是15495，因此要存储到103节点。到了7003后，执行<code>get num</code>时，对num做hash运算，对16384取余，得到的结果是2765，因此需要切换到7001节点</p><h5 id="小结-3" tabindex="-1"><a class="header-anchor" href="#小结-3" aria-hidden="true">#</a> 小结</h5><p>Redis如何判断某个key应该在哪个实例？</p><ul><li>将16384个插槽分配到不同的实例</li><li>根据key的有效部分计算哈希值，对16384取余</li><li>余数作为插槽，寻找插槽所在实例即可</li></ul><p>如何将同一类数据固定的保存在同一个Redis实例？</p><ul><li>这一类数据使用相同的有效部分，例如key都以{typeId}为前缀</li></ul><h4 id="集群伸缩" tabindex="-1"><a class="header-anchor" href="#集群伸缩" aria-hidden="true">#</a> 集群伸缩</h4><p>redis-cli --cluster提供了很多操作集群的命令，可以通过下面方式查看：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>redis-cli <span class="token parameter variable">--cluster</span> <span class="token builtin class-name">help</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h5 id="需求分析" tabindex="-1"><a class="header-anchor" href="#需求分析" aria-hidden="true">#</a> 需求分析</h5><p>需求：向集群中添加一个新的master节点，并向其中存储 num = 10</p><ul><li>启动一个新的redis实例，端口为7004</li><li>添加7004到之前的集群，并作为一个master节点</li><li>给7004节点分配插槽，使得num这个key可以存储到7004实例</li></ul><p>这里需要两个新的功能：</p><ul><li>添加一个节点到集群中</li><li>将部分插槽分配到新插槽</li></ul><h5 id="实现" tabindex="-1"><a class="header-anchor" href="#实现" aria-hidden="true">#</a> 实现</h5><p>创建新的实例，并启动，然后添加新节点到redis集群</p><img src="/home/assets/image-20210725160448139-c77ca11f.png" alt="image-20210725160448139" style="zoom:67%;"><p>执行命令：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>redis-cli <span class="token parameter variable">--cluster</span> add-node  <span class="token number">192.168</span>.150.101:7004 <span class="token number">192.168</span>.150.101:7001
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>通过命令查看集群状态：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>redis-cli <span class="token parameter variable">-p</span> <span class="token number">7001</span> cluster nodes
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>可以观察到7004默认为master节点，并且没有插槽</p><p>接下来移动插槽</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>redis-cli <span class="token parameter variable">--cluster</span> reshard <span class="token number">192.168</span>.150.101:7001
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>然后根据提示，填写需要移动的插槽个数和移动插槽的源节点和目标节点ID，即可完成</p><p>最后可以通过上面的命令查看集群，可以发现7004已经有插槽了。接下里就可以读数据和写数据了</p><h4 id="故障转移" tabindex="-1"><a class="header-anchor" href="#故障转移" aria-hidden="true">#</a> 故障转移</h4><h5 id="原理" tabindex="-1"><a class="header-anchor" href="#原理" aria-hidden="true">#</a> 原理</h5><p>Redis分片集群有自动故障转移处理，他会自动检测节点存活，并重新选举</p><p>利用cluster failover命令也可以手动让集群中的某个master宕机，切换到执行cluster failover命令的这个slave节点，实现无感知的数据迁移。其流程如下：</p><img src="/home/assets/image-20210725162441407-234af58b.png" alt="image-20210725162441407" style="zoom:50%;"><p>这种failover命令可以指定三种模式：</p><ul><li>缺省：默认的流程，如图1~6歩</li><li>force：省略了对offset的一致性校验</li><li>takeover：直接执行第5歩，忽略数据一致性、忽略master状态和其它master的意见</li></ul><p>如：对7002slave节点执行该命令，他之后会称为master节点，原来的master会变成slave</p><p><img src="/home/assets/image-20240228224649861-4a7b9e57.png" alt="image-20240228224649861"></p><h5 id="redistemplate访问分片集群" tabindex="-1"><a class="header-anchor" href="#redistemplate访问分片集群" aria-hidden="true">#</a> RedisTemplate访问分片集群</h5><p>RedisTemplate底层同样基于lettuce实现了分片集群的支持，而使用的步骤与哨兵模式基本一致：</p><p>1）引入redis的starter依赖</p><p>2）配置分片集群地址</p><p>3）配置读写分离</p><p>与哨兵模式相比，其中只有分片集群的配置方式略有差异，如下：</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">redis</span><span class="token punctuation">:</span>
    <span class="token key atrule">cluster</span><span class="token punctuation">:</span>
      <span class="token key atrule">nodes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> 192.168.150.101<span class="token punctuation">:</span><span class="token number">7001</span>
        <span class="token punctuation">-</span> 192.168.150.101<span class="token punctuation">:</span><span class="token number">7002</span>
        <span class="token punctuation">-</span> 192.168.150.101<span class="token punctuation">:</span><span class="token number">7003</span>
        <span class="token punctuation">-</span> 192.168.150.101<span class="token punctuation">:</span><span class="token number">8001</span>
        <span class="token punctuation">-</span> 192.168.150.101<span class="token punctuation">:</span><span class="token number">8002</span>
        <span class="token punctuation">-</span> 192.168.150.101<span class="token punctuation">:</span><span class="token number">8003</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_1-多级缓存" tabindex="-1"><a class="header-anchor" href="#_1-多级缓存" aria-hidden="true">#</a> 1.多级缓存</h2><p>传统的缓存策略一般是请求到达Tomcat后，先查询Redis，如果未命中则查询数据库，如图：</p><img src="/home/assets/image-20210821075259137-b8eea716.png" alt="image-20210821075259137" style="zoom:33%;"><p>存在下面的问题：</p><ul><li><p>请求要经过Tomcat处理，Tomcat的性能成为整个系统的瓶颈</p></li><li><p>Redis缓存失效时，会对数据库产生冲击</p></li></ul><img src="/home/assets/image-20210821080954947-92d4511f.png" alt="image-20210821080954947" style="zoom:50%;"><p>多级缓存就是充分利用请求处理的每个环节，分别添加缓存，减轻Tomcat压力，提升服务性能：</p><ul><li>浏览器访问静态资源时，优先读取浏览器本地缓存</li><li>访问非静态资源（ajax查询数据）时，访问服务端</li><li>请求到达Nginx后，优先读取Nginx本地缓存</li><li>如果Nginx本地缓存未命中，则去直接查询Redis（不经过Tomcat）</li><li>如果Redis查询未命中，则查询Tomcat</li><li>请求进入Tomcat后，优先查询JVM进程缓存</li><li>如果JVM进程缓存未命中，则查询数据库</li></ul><p>可见，多级缓存的关键有两个：</p><ul><li><p>一个是在nginx中编写业务，实现nginx本地缓存、Redis、Tomcat的查询</p></li><li><p>另一个就是在Tomcat中实现JVM进程缓存</p></li></ul><p>在多级缓存架构中，Nginx内部需要编写本地缓存查询、Redis查询、Tomcat查询的业务逻辑，因此这样的nginx服务不再是一个<strong>反向代理服务器</strong>，而是一个编写<strong>业务的Web服务器了</strong>。Nginx编程则会用到OpenResty框架结合Lua这样的语言。</p><h3 id="_1-1-jvm进程缓存" tabindex="-1"><a class="header-anchor" href="#_1-1-jvm进程缓存" aria-hidden="true">#</a> 1.1.JVM进程缓存</h3><h4 id="caffeine" tabindex="-1"><a class="header-anchor" href="#caffeine" aria-hidden="true">#</a> Caffeine</h4><p>缓存在日常开发中启动至关重要的作用，由于是存储在内存中，数据的读取速度是非常快的，能大量减少对数据库的访问，减少数据库的压力。缓存分为两类：</p><ul><li>分布式缓存，例如Redis： <ul><li>优点：存储容量更大、可靠性更好、可以在集群间共享</li><li>缺点：访问缓存有网络开销</li><li>场景：缓存数据量较大、可靠性要求较高、需要在集群间共享</li></ul></li><li>进程本地缓存，例如HashMap、GuavaCache： <ul><li>优点：读取本地内存，没有网络开销，速度更快</li><li>缺点：存储容量有限、可靠性较低、无法共享</li><li>场景：性能要求较高，缓存数据量较小</li></ul></li></ul><p><strong>Caffeine</strong>是一个基于Java8开发的，提供了近乎最佳命中率的高性能的本地缓存库。目前Spring内部的缓存使用的就是Caffeine。GitHub地址：https://github.com/ben-manes/caffeine</p><p>Caffeine既然是缓存的一种，肯定需要有缓存的清除策略，不然的话内存总会有耗尽的时候。</p><p>Caffeine提供了三种缓存驱逐策略：</p><ul><li><p><strong>基于容量</strong>：设置缓存的数量上限</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// 创建缓存对象</span>
<span class="token class-name">Cache</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> cache <span class="token operator">=</span> <span class="token class-name">Caffeine</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">maximumSize</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">// 设置缓存大小上限为 1</span>
    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p><strong>基于时间</strong>：设置缓存的有效时间</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// 创建缓存对象</span>
<span class="token class-name">Cache</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> cache <span class="token operator">=</span> <span class="token class-name">Caffeine</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 设置缓存有效期为 10 秒，从最后一次写入开始计时 </span>
    <span class="token punctuation">.</span><span class="token function">expireAfterWrite</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofSeconds</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p><strong>基于引用</strong>：设置缓存为软引用或弱引用，利用GC来回收缓存数据。性能较差，不建议使用。</p></li></ul><blockquote><p><strong>注意</strong>：在默认情况下，当一个缓存元素过期的时候，Caffeine不会自动立即将其清理和驱逐。而是在一次读或写操作后，或者在空闲时间完成对失效数据的驱逐。</p></blockquote><p>基本API</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">testBasicOps</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 构建cache对象</span>
  <span class="token class-name">Cache</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> cache <span class="token operator">=</span> <span class="token class-name">Caffeine</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 存数据</span>
  cache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;gf&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;xx&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 取数据</span>
  <span class="token class-name">String</span> gf <span class="token operator">=</span> cache<span class="token punctuation">.</span><span class="token function">getIfPresent</span><span class="token punctuation">(</span><span class="token string">&quot;gf&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 取数据，包含两个参数：</span>
  <span class="token comment">// 参数一：缓存的key</span>
  <span class="token comment">// 参数二：Lambda表达式，表达式参数就是缓存的key，方法体是查询数据库的逻辑</span>
  <span class="token comment">// 优先根据key查询JVM缓存，如果未命中，则执行参数二的Lambda表达式</span>
  <span class="token class-name">String</span> defaultGF <span class="token operator">=</span> cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;defaultGF&quot;</span><span class="token punctuation">,</span> key <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 根据key去数据库查询数据</span>
    <span class="token keyword">return</span> <span class="token string">&quot;xx&quot;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="实现-1" tabindex="-1"><a class="header-anchor" href="#实现-1" aria-hidden="true">#</a> 实现</h4><p>首先，我们需要定义两个Caffeine的缓存对象，分别保存商品、库存的缓存数据。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CaffeineConfig</span> <span class="token punctuation">{</span>
  <span class="token annotation punctuation">@Bean</span>
  <span class="token keyword">public</span> <span class="token class-name">Cache</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Item</span><span class="token punctuation">&gt;</span></span> <span class="token function">itemCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token class-name">Caffeine</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">initialCapacity</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">maximumSize</span><span class="token punctuation">(</span><span class="token number">10_000</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token annotation punctuation">@Bean</span>
  <span class="token keyword">public</span> <span class="token class-name">Cache</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">ItemStock</span><span class="token punctuation">&gt;</span></span> <span class="token function">stockCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token class-name">Caffeine</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">initialCapacity</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">maximumSize</span><span class="token punctuation">(</span><span class="token number">10_000</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>使用缓存</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;item&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ItemController</span> <span class="token punctuation">{</span>
  <span class="token annotation punctuation">@Autowired</span>
  <span class="token keyword">private</span> <span class="token class-name">IItemService</span> itemService<span class="token punctuation">;</span>
  <span class="token annotation punctuation">@Autowired</span>
  <span class="token keyword">private</span> <span class="token class-name">IItemStockService</span> stockService<span class="token punctuation">;</span>
  <span class="token annotation punctuation">@Autowired</span>
  <span class="token keyword">private</span> <span class="token class-name">Cache</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Item</span><span class="token punctuation">&gt;</span></span> itemCache<span class="token punctuation">;</span>
  <span class="token annotation punctuation">@Autowired</span>
  <span class="token keyword">private</span> <span class="token class-name">Cache</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">ItemStock</span><span class="token punctuation">&gt;</span></span> stockCache<span class="token punctuation">;</span>

  <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/{id}&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">public</span> <span class="token class-name">Item</span> <span class="token function">findById</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> itemCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> key <span class="token operator">-&gt;</span> itemService<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                         <span class="token punctuation">.</span><span class="token function">ne</span><span class="token punctuation">(</span><span class="token string">&quot;status&quot;</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span>
                         <span class="token punctuation">.</span><span class="token function">one</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/stock/{id}&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">public</span> <span class="token class-name">ItemStock</span> <span class="token function">findStockById</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> stockCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> key <span class="token operator">-&gt;</span> stockService<span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_1-2-lua入门" tabindex="-1"><a class="header-anchor" href="#_1-2-lua入门" aria-hidden="true">#</a> 1.2.Lua入门</h3><p>Lua 是一种轻量小巧的脚本语言，用标准C语言编写并以源代码形式开放， 其设计目的是为了嵌入应用程序中，从而为应用程序提供灵活的扩展和定制功能。官网：https://www.lua.org/</p><p>Lua经常嵌入到C语言开发的程序中，例如游戏开发、游戏插件等。</p><p>Nginx本身也是C语言开发，因此也允许基于Lua做拓展。</p><h4 id="数据类型" tabindex="-1"><a class="header-anchor" href="#数据类型" aria-hidden="true">#</a> 数据类型</h4><p>Lua中支持的常见数据类型包括：</p><img src="/home/assets/image-20210821091835406-1062c395.png" alt="image-20210821091835406" style="zoom:50%;"><p>另外，Lua提供了type()函数来判断一个变量的数据类型.</p><h4 id="声明变量" tabindex="-1"><a class="header-anchor" href="#声明变量" aria-hidden="true">#</a> 声明变量</h4><p>Lua声明变量的时候无需指定数据类型，而是用local来声明变量为局部变量：</p><div class="language-lua line-numbers-mode" data-ext="lua"><pre class="language-lua"><code><span class="token comment">-- 声明字符串，可以用单引号或双引号，</span>
<span class="token keyword">local</span> str <span class="token operator">=</span> <span class="token string">&#39;hello&#39;</span>
<span class="token comment">-- 字符串拼接可以使用 ..</span>
<span class="token keyword">local</span> str2 <span class="token operator">=</span> <span class="token string">&#39;hello&#39;</span> <span class="token operator">..</span> <span class="token string">&#39;world&#39;</span>
<span class="token comment">-- 声明数字</span>
<span class="token keyword">local</span> num <span class="token operator">=</span> <span class="token number">21</span>
<span class="token comment">-- 声明布尔类型</span>
<span class="token keyword">local</span> flag <span class="token operator">=</span> <span class="token keyword">true</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Lua中的table类型既可以作为数组，又可以作为Java中的map来使用。数组就是特殊的table，key是数组角标而已：</p><div class="language-lua line-numbers-mode" data-ext="lua"><pre class="language-lua"><code><span class="token comment">-- 声明数组 ，key为角标的 table</span>
<span class="token keyword">local</span> arr <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&#39;java&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;python&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;lua&#39;</span><span class="token punctuation">}</span>
<span class="token comment">-- 声明table，类似java的map</span>
<span class="token keyword">local</span> map <span class="token operator">=</span>  <span class="token punctuation">{</span>name<span class="token operator">=</span><span class="token string">&#39;Jack&#39;</span><span class="token punctuation">,</span> age<span class="token operator">=</span><span class="token number">21</span><span class="token punctuation">}</span>
<span class="token comment">-- 访问数组，lua数组的角标从1开始</span>
<span class="token function">print</span><span class="token punctuation">(</span>arr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment">-- 访问table</span>
<span class="token function">print</span><span class="token punctuation">(</span>map<span class="token punctuation">[</span><span class="token string">&#39;name&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token function">print</span><span class="token punctuation">(</span>map<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="循环" tabindex="-1"><a class="header-anchor" href="#循环" aria-hidden="true">#</a> 循环</h4><p>遍历数组：</p><div class="language-lua line-numbers-mode" data-ext="lua"><pre class="language-lua"><code><span class="token comment">-- 声明数组 key为索引的 table</span>
<span class="token keyword">local</span> arr <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&#39;java&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;python&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;lua&#39;</span><span class="token punctuation">}</span>
<span class="token comment">-- 遍历数组</span>
<span class="token keyword">for</span> index<span class="token punctuation">,</span>value <span class="token keyword">in</span> <span class="token function">ipairs</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span> <span class="token keyword">do</span>
    <span class="token function">print</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> value<span class="token punctuation">)</span> 
<span class="token keyword">end</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>遍历普通table</p><div class="language-lua line-numbers-mode" data-ext="lua"><pre class="language-lua"><code><span class="token comment">-- 声明map，也就是table</span>
<span class="token keyword">local</span> map <span class="token operator">=</span> <span class="token punctuation">{</span>name<span class="token operator">=</span><span class="token string">&#39;Jack&#39;</span><span class="token punctuation">,</span> age<span class="token operator">=</span><span class="token number">21</span><span class="token punctuation">}</span>
<span class="token comment">-- 遍历table</span>
<span class="token keyword">for</span> key<span class="token punctuation">,</span>value <span class="token keyword">in</span> <span class="token function">pairs</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span> <span class="token keyword">do</span>
   <span class="token function">print</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span> 
<span class="token keyword">end</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="条件控制、函数" tabindex="-1"><a class="header-anchor" href="#条件控制、函数" aria-hidden="true">#</a> 条件控制、函数</h4><p>定义函数的语法：</p><div class="language-lua line-numbers-mode" data-ext="lua"><pre class="language-lua"><code><span class="token keyword">function</span> 函数名<span class="token punctuation">(</span> argument1<span class="token punctuation">,</span> argument2<span class="token punctuation">...</span><span class="token punctuation">,</span> argumentn<span class="token punctuation">)</span>
    <span class="token comment">-- 函数体</span>
    <span class="token keyword">return</span> 返回值
<span class="token keyword">end</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>条件控制，例如if、else语法：</p><div class="language-lua line-numbers-mode" data-ext="lua"><pre class="language-lua"><code><span class="token keyword">if</span><span class="token punctuation">(</span>布尔表达式<span class="token punctuation">)</span>
<span class="token keyword">then</span>
   <span class="token comment">--[ 布尔表达式为 true 时执行该语句块 --]</span>
<span class="token keyword">else</span>
   <span class="token comment">--[ 布尔表达式为 false 时执行该语句块 --]</span>
<span class="token keyword">end</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>与java不同，布尔表达式中的逻辑运算是基于英文单词：</p><img src="/home/assets/image-20210821092657918-bffae7a2.png" alt="image-20210821092657918" style="zoom:50%;"><h3 id="_1-3-实现多级缓存" tabindex="-1"><a class="header-anchor" href="#_1-3-实现多级缓存" aria-hidden="true">#</a> 1.3.实现多级缓存</h3><p>多级缓存的实现离不开Nginx编程，而Nginx编程又离不开OpenResty。</p><p>OpenResty 是一个基于 Nginx的高性能 Web 平台，用于方便地搭建能够处理超高并发、扩展性极高的动态 Web 应用、Web 服务和动态网关。具备下列特点：</p><ul><li>具备Nginx的完整功能</li><li>基于Lua语言进行扩展，集成了大量精良的 Lua 库、第三方模块</li><li>允许使用Lua<strong>自定义业务逻辑</strong>、<strong>自定义库</strong></li></ul><p>官方网站： https://openresty.org/cn/</p><h4 id="实现-2" tabindex="-1"><a class="header-anchor" href="#实现-2" aria-hidden="true">#</a> 实现</h4><p>里面有一些语法和设置啥的，不写了，直接给个文件吧</p><p>首先配置请求有lua脚本解析</p><div class="language-nginx line-numbers-mode" data-ext="nginx"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">location</span> ~ /api/item/(\d+)</span> <span class="token punctuation">{</span>
    <span class="token comment"># 默认的响应类型</span>
    <span class="token directive"><span class="token keyword">default_type</span> application/json</span><span class="token punctuation">;</span>
    <span class="token comment"># 响应结果由lua/item.lua文件来决定</span>
    <span class="token directive"><span class="token keyword">content_by_lua_file</span> lua/item.lua</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>完整common.lua，工具函数库</p><div class="language-lua line-numbers-mode" data-ext="lua"><pre class="language-lua"><code><span class="token comment">-- 导入redis</span>
<span class="token keyword">local</span> redis <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;resty.redis&#39;</span><span class="token punctuation">)</span>
<span class="token comment">-- 初始化redis</span>
<span class="token keyword">local</span> red <span class="token operator">=</span> redis<span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
red<span class="token punctuation">:</span><span class="token function">set_timeouts</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>

<span class="token comment">-- 关闭redis连接的工具方法，其实是放入连接池</span>
<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">close_redis</span><span class="token punctuation">(</span>red<span class="token punctuation">)</span>
    <span class="token keyword">local</span> pool_max_idle_time <span class="token operator">=</span> <span class="token number">10000</span> <span class="token comment">-- 连接的空闲时间，单位是毫秒</span>
    <span class="token keyword">local</span> pool_size <span class="token operator">=</span> <span class="token number">100</span> <span class="token comment">--连接池大小</span>
    <span class="token keyword">local</span> ok<span class="token punctuation">,</span> err <span class="token operator">=</span> red<span class="token punctuation">:</span><span class="token function">set_keepalive</span><span class="token punctuation">(</span>pool_max_idle_time<span class="token punctuation">,</span> pool_size<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> ok <span class="token keyword">then</span>
        ngx<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ngx<span class="token punctuation">.</span>ERR<span class="token punctuation">,</span> <span class="token string">&quot;放入redis连接池失败: &quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    <span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token comment">-- 查询redis的方法 ip和port是redis地址，key是查询的key</span>
<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">read_redis</span><span class="token punctuation">(</span>ip<span class="token punctuation">,</span> port<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
    <span class="token comment">-- 获取一个连接</span>
    <span class="token keyword">local</span> ok<span class="token punctuation">,</span> err <span class="token operator">=</span> red<span class="token punctuation">:</span><span class="token function">connect</span><span class="token punctuation">(</span>ip<span class="token punctuation">,</span> port<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> ok <span class="token keyword">then</span>
        ngx<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ngx<span class="token punctuation">.</span>ERR<span class="token punctuation">,</span> <span class="token string">&quot;连接redis失败 : &quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token keyword">nil</span>
    <span class="token keyword">end</span>
    <span class="token comment">-- 查询redis</span>
    <span class="token keyword">local</span> resp<span class="token punctuation">,</span> err <span class="token operator">=</span> red<span class="token punctuation">:</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
    <span class="token comment">-- 查询失败处理</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> resp <span class="token keyword">then</span>
        ngx<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ngx<span class="token punctuation">.</span>ERR<span class="token punctuation">,</span> <span class="token string">&quot;查询Redis失败: &quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">,</span> <span class="token string">&quot;, key = &quot;</span> <span class="token punctuation">,</span> key<span class="token punctuation">)</span>
    <span class="token keyword">end</span>
    <span class="token comment">--得到的数据为空处理</span>
    <span class="token keyword">if</span> resp <span class="token operator">==</span> ngx<span class="token punctuation">.</span>null <span class="token keyword">then</span>
        resp <span class="token operator">=</span> <span class="token keyword">nil</span>
        ngx<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ngx<span class="token punctuation">.</span>ERR<span class="token punctuation">,</span> <span class="token string">&quot;查询Redis数据为空, key = &quot;</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span>
    <span class="token keyword">end</span>
    <span class="token function">close_redis</span><span class="token punctuation">(</span>red<span class="token punctuation">)</span>
    <span class="token keyword">return</span> resp
<span class="token keyword">end</span>

<span class="token comment">-- 封装函数，发送http请求，并解析响应</span>
<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">read_http</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> params<span class="token punctuation">)</span>
    <span class="token keyword">local</span> resp <span class="token operator">=</span> ngx<span class="token punctuation">.</span>location<span class="token punctuation">.</span><span class="token function">capture</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span><span class="token punctuation">{</span>
        method <span class="token operator">=</span> ngx<span class="token punctuation">.</span>HTTP_GET<span class="token punctuation">,</span>
        args <span class="token operator">=</span> params<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> resp <span class="token keyword">then</span>
        <span class="token comment">-- 记录错误信息，返回404</span>
        ngx<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ngx<span class="token punctuation">.</span>ERR<span class="token punctuation">,</span> <span class="token string">&quot;http查询失败, path: &quot;</span><span class="token punctuation">,</span> path <span class="token punctuation">,</span> <span class="token string">&quot;, args: &quot;</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span>
        ngx<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">)</span>
    <span class="token keyword">end</span>
    <span class="token keyword">return</span> resp<span class="token punctuation">.</span>body
<span class="token keyword">end</span>
<span class="token comment">-- 将方法导出</span>
<span class="token keyword">local</span> _M <span class="token operator">=</span> <span class="token punctuation">{</span>  
    read_http <span class="token operator">=</span> read_http<span class="token punctuation">,</span>
    read_redis <span class="token operator">=</span> read_redis
<span class="token punctuation">}</span>  
<span class="token keyword">return</span> _M
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>业务文件lua/item.lua</p><div class="language-lua line-numbers-mode" data-ext="lua"><pre class="language-lua"><code><span class="token comment">-- 导入common函数库</span>
<span class="token keyword">local</span> common <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;common&#39;</span><span class="token punctuation">)</span>
<span class="token keyword">local</span> read_http <span class="token operator">=</span> common<span class="token punctuation">.</span>read_http
<span class="token keyword">local</span> read_redis <span class="token operator">=</span> common<span class="token punctuation">.</span>read_redis
<span class="token comment">-- 导入cjson库</span>
<span class="token keyword">local</span> cjson <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;cjson&#39;</span><span class="token punctuation">)</span>
<span class="token comment">-- 导入共享词典，本地缓存</span>
<span class="token keyword">local</span> item_cache <span class="token operator">=</span> ngx<span class="token punctuation">.</span>shared<span class="token punctuation">.</span>item_cache

<span class="token comment">-- 封装查询函数</span>
<span class="token keyword">function</span> <span class="token function">read_data</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> expire<span class="token punctuation">,</span> path<span class="token punctuation">,</span> params<span class="token punctuation">)</span>
    <span class="token comment">-- 查询本地缓存</span>
    <span class="token keyword">local</span> val <span class="token operator">=</span> item_cache<span class="token punctuation">:</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> val <span class="token keyword">then</span>
        ngx<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ngx<span class="token punctuation">.</span>ERR<span class="token punctuation">,</span> <span class="token string">&quot;本地缓存查询失败，尝试查询Redis， key: &quot;</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span>
        <span class="token comment">-- 查询redis</span>
        val <span class="token operator">=</span> <span class="token function">read_redis</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">,</span> <span class="token number">6379</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span>
        <span class="token comment">-- 判断查询结果</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> val <span class="token keyword">then</span>
            ngx<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ngx<span class="token punctuation">.</span>ERR<span class="token punctuation">,</span> <span class="token string">&quot;redis查询失败，尝试查询http， key: &quot;</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span>
            <span class="token comment">-- redis查询失败，去查询http</span>
            val <span class="token operator">=</span> <span class="token function">read_http</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> params<span class="token punctuation">)</span>
        <span class="token keyword">end</span>
        <span class="token comment">-- 查询成功，把数据写入本地缓存</span>
    		item_cache<span class="token punctuation">:</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> val<span class="token punctuation">,</span> expire<span class="token punctuation">)</span>
    <span class="token keyword">end</span>
    <span class="token comment">-- 返回数据</span>
    <span class="token keyword">return</span> val
<span class="token keyword">end</span>

<span class="token comment">-- 获取路径参数</span>
<span class="token keyword">local</span> id <span class="token operator">=</span> ngx<span class="token punctuation">.</span>var<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>

<span class="token comment">-- 查询商品信息</span>
<span class="token keyword">local</span> itemJSON <span class="token operator">=</span> <span class="token function">read_data</span><span class="token punctuation">(</span><span class="token string">&quot;item:id:&quot;</span> <span class="token operator">..</span> id<span class="token punctuation">,</span> <span class="token number">1800</span><span class="token punctuation">,</span>  <span class="token string">&quot;/item/&quot;</span> <span class="token operator">..</span> id<span class="token punctuation">,</span> <span class="token keyword">nil</span><span class="token punctuation">)</span>
<span class="token comment">-- 查询库存信息</span>
<span class="token keyword">local</span> stockJSON <span class="token operator">=</span> <span class="token function">read_data</span><span class="token punctuation">(</span><span class="token string">&quot;item:stock:id:&quot;</span> <span class="token operator">..</span> id<span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">,</span> <span class="token string">&quot;/item/stock/&quot;</span> <span class="token operator">..</span> id<span class="token punctuation">,</span> <span class="token keyword">nil</span><span class="token punctuation">)</span>

<span class="token comment">-- JSON转化为lua的table</span>
<span class="token keyword">local</span> item <span class="token operator">=</span> cjson<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>itemJSON<span class="token punctuation">)</span>
<span class="token keyword">local</span> stock <span class="token operator">=</span> cjson<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>stockJSON<span class="token punctuation">)</span>
<span class="token comment">-- 组合数据</span>
item<span class="token punctuation">.</span>stock <span class="token operator">=</span> stock<span class="token punctuation">.</span>stock
item<span class="token punctuation">.</span>sold <span class="token operator">=</span> stock<span class="token punctuation">.</span>sold

<span class="token comment">-- 把item序列化为json 返回结果</span>
ngx<span class="token punctuation">.</span><span class="token function">say</span><span class="token punctuation">(</span>cjson<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里面涉及的知识点：</p><ul><li>OpenResty使用lua操作redis</li><li>OpenResty的共享缓存</li><li>OpenResty的网络请求</li></ul><h4 id="hash负载均衡" tabindex="-1"><a class="header-anchor" href="#hash负载均衡" aria-hidden="true">#</a> hash负载均衡</h4><p>然后有集群的话，需要考虑负载均衡，不能采取轮询的方式，否则会造成缓存重复等问题，需要使用hash进行映射，如下：</p><p>修改<code>/usr/local/openresty/nginx/conf/nginx.conf</code>文件，实现基于ID做负载均衡。</p><p>首先，定义tomcat集群，并设置基于路径做负载均衡：</p><div class="language-nginx line-numbers-mode" data-ext="nginx"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">upstream</span> tomcat-cluster</span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">hash</span> <span class="token variable">$request_uri</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server</span> 192.168.150.1:8081</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server</span> 192.168.150.1:8082</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>然后，修改对tomcat服务的反向代理，目标指向tomcat集群：</p><div class="language-nginx line-numbers-mode" data-ext="nginx"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">location</span> /item</span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">proxy_pass</span> http://tomcat-cluster</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>重新加载OpenResty</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>nginx <span class="token parameter variable">-s</span> reload
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h4 id="openresty本地缓存" tabindex="-1"><a class="header-anchor" href="#openresty本地缓存" aria-hidden="true">#</a> OpenResty本地缓存</h4><p>OpenResty为Nginx提供了<strong>shard dict</strong>的功能，可以在nginx的多个worker之间共享数据，实现缓存功能。</p><p>1）开启共享字典，在nginx.conf的http下添加配置：</p><div class="language-nginx line-numbers-mode" data-ext="nginx"><pre class="language-nginx"><code> <span class="token comment"># 共享字典，也就是本地缓存，名称叫做：item_cache，大小150m</span>
 <span class="token directive"><span class="token keyword">lua_shared_dict</span> item_cache <span class="token number">150m</span></span><span class="token punctuation">;</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>2）操作共享字典：</p><div class="language-lua line-numbers-mode" data-ext="lua"><pre class="language-lua"><code><span class="token comment">-- 获取本地缓存对象</span>
<span class="token keyword">local</span> item_cache <span class="token operator">=</span> ngx<span class="token punctuation">.</span>shared<span class="token punctuation">.</span>item_cache
<span class="token comment">-- 存储, 指定key、value、过期时间，单位s，默认为0代表永不过期</span>
item_cache<span class="token punctuation">:</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&#39;key&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;value&#39;</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>
<span class="token comment">-- 读取</span>
<span class="token keyword">local</span> val <span class="token operator">=</span> item_cache<span class="token punctuation">:</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;key&#39;</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="nginx发送http" tabindex="-1"><a class="header-anchor" href="#nginx发送http" aria-hidden="true">#</a> nginx发送http</h4><p>nginx提供了内部API用以发送http请求：</p><div class="language-lua line-numbers-mode" data-ext="lua"><pre class="language-lua"><code><span class="token keyword">local</span> resp <span class="token operator">=</span> ngx<span class="token punctuation">.</span>location<span class="token punctuation">.</span><span class="token function">capture</span><span class="token punctuation">(</span><span class="token string">&quot;/path&quot;</span><span class="token punctuation">,</span><span class="token punctuation">{</span>
    method <span class="token operator">=</span> ngx<span class="token punctuation">.</span>HTTP_GET<span class="token punctuation">,</span>   <span class="token comment">-- 请求方式</span>
    args <span class="token operator">=</span> <span class="token punctuation">{</span>a<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>b<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token comment">-- get方式传参数</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>返回的响应内容包括：</p><ul><li>resp.status：响应状态码</li><li>resp.header：响应头，是一个table</li><li>resp.body：响应体，就是响应数据</li></ul><p>注意：这里的path是路径，并不包含IP和端口。这个请求会被nginx内部的server监听并处理，也就是请求自己，然后需要写一个反向代理，去请求服务器。</p><div class="language-nginx line-numbers-mode" data-ext="nginx"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">location</span> /path</span> <span class="token punctuation">{</span>
  <span class="token directive"><span class="token keyword">proxy_pass</span> http://192.168.150.1:8081</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="openresty请求参数处理" tabindex="-1"><a class="header-anchor" href="#openresty请求参数处理" aria-hidden="true">#</a> OpenResty请求参数处理</h4><p>OpenResty中提供了一些API用来获取不同类型的前端请求参数：</p><img src="/home/assets/image-20210821101433528-6c98b488.png" alt="image-20210821101433528" style="zoom:50%;"><h4 id="redis缓存预热" tabindex="-1"><a class="header-anchor" href="#redis缓存预热" aria-hidden="true">#</a> Redis缓存预热</h4><p>Redis缓存会面临冷启动问题：</p><p><strong>冷启动</strong>：服务刚刚启动时，Redis中并没有缓存，如果所有商品数据都在第一次查询时添加缓存，可能会给数据库带来较大压力。</p><p><strong>缓存预热</strong>：在实际开发中，我们可以利用大数据统计用户访问的热点数据，在项目启动时将这些热点数据提前查询并保存到Redis中。</p><p>引入Redis依赖</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-data-redis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>配置Redis地址</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">redis</span><span class="token punctuation">:</span>
    <span class="token key atrule">host</span><span class="token punctuation">:</span> 192.168.150.101
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>编写初始化类</p><p>缓存预热需要在项目启动时完成，并且必须是拿到RedisTemplate之后。这里利用InitializingBean接口来实现，InitializingBean在对象被Spring创建并且成员变量全部注入后执行。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisHandler</span> <span class="token keyword">implements</span> <span class="token class-name">InitializingBean</span> <span class="token punctuation">{</span>
  <span class="token annotation punctuation">@Autowired</span>
  <span class="token keyword">private</span> <span class="token class-name">StringRedisTemplate</span> redisTemplate<span class="token punctuation">;</span>
  <span class="token annotation punctuation">@Autowired</span>
  <span class="token keyword">private</span> <span class="token class-name">IItemService</span> itemService<span class="token punctuation">;</span>
  <span class="token annotation punctuation">@Autowired</span>
  <span class="token keyword">private</span> <span class="token class-name">IItemStockService</span> stockService<span class="token punctuation">;</span>
	<span class="token comment">// 处理json</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ObjectMapper</span> <span class="token constant">MAPPER</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 这里查询热点数据即可</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterPropertiesSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token comment">// 初始化缓存</span>
    <span class="token comment">// 1.查询商品信息</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Item</span><span class="token punctuation">&gt;</span></span> itemList <span class="token operator">=</span> itemService<span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2.放入缓存</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Item</span> item <span class="token operator">:</span> itemList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 2.1.item序列化为JSON</span>
      <span class="token class-name">String</span> json <span class="token operator">=</span> <span class="token constant">MAPPER</span><span class="token punctuation">.</span><span class="token function">writeValueAsString</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 2.2.存入redis</span>
      redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;item:id:&quot;</span> <span class="token operator">+</span> item<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> json<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_1-4-数据同步策略" tabindex="-1"><a class="header-anchor" href="#_1-4-数据同步策略" aria-hidden="true">#</a> 1.4.数据同步策略</h3><p>缓存数据同步的常见方式有三种：</p><p><strong>设置有效期</strong>：给缓存设置有效期，到期后自动删除。再次查询时更新</p><ul><li>优势：简单、方便</li><li>缺点：时效性差，缓存过期之前可能不一致</li><li>场景：更新频率较低，时效性要求低的业务</li></ul><p><strong>同步双写</strong>：在修改数据库的同时，直接修改缓存</p><ul><li>优势：时效性强，缓存与数据库强一致</li><li>缺点：有代码侵入，耦合度高；</li><li>场景：对一致性、时效性要求较高的缓存数据</li></ul><p>**异步通知：**修改数据库时发送事件通知，相关服务监听到通知后修改缓存数据</p><ul><li>优势：低耦合，可以同时通知多个缓存服务</li><li>缺点：时效性一般，可能存在中间不一致状态</li><li>场景：时效性要求一般，有多个服务需要同步</li></ul><p>而异步实现又可以基于MQ或者Canal来实现：</p><p>1）基于MQ的异步通知：</p><img src="/home/assets/image-20210821115552327-fb22bb29.png" alt="image-20210821115552327" style="zoom:33%;"><p>解读：</p><ul><li>商品服务完成对数据的修改后，只需要发送一条消息到MQ中。</li><li>缓存服务监听MQ消息，然后完成对缓存的更新</li></ul><p>依然有少量的代码侵入。</p><p>2）基于Canal的通知</p><img src="/home/assets/image-20210821115719363-68ff4485.png" alt="image-20210821115719363" style="zoom:33%;"><p>解读：</p><ul><li>商品服务完成商品修改后，业务直接结束，没有任何代码侵入</li><li>Canal监听MySQL变化，当发现变化后，立即通知缓存服务</li><li>缓存服务接收到canal通知，更新缓存</li></ul><p>代码零侵入</p><p><strong>Canal [kə&#39;næl]</strong>，译意为水道/管道/沟渠，canal是阿里巴巴旗下的一款开源项目，基于Java开发。基于数据库增量日志解析，提供增量数据订阅&amp;消费。GitHub的地址：https://github.com/alibaba/canal</p><p>Canal是基于mysql的主从同步来实现的，MySQL主从同步的原理如下：</p><img src="/home/assets/image-20210821115914748-86722d05.png" alt="image-20210821115914748" style="zoom:50%;"><ul><li>1）MySQL master 将数据变更写入二进制日志( binary log），其中记录的数据叫做binary log events</li><li>2）MySQL slave 将 master 的 binary log events拷贝到它的中继日志(relay log)</li><li>3）MySQL slave 重放 relay log 中事件，将数据变更反映它自己的数据</li></ul><p>而Canal就是把自己伪装成MySQL的一个slave节点，从而监听master的binary log变化。再把得到的变化信息通知给Canal的客户端（调用函数而已，用户只需要重写函数即可），进而完成对其它数据库的同步。</p><p>springboot有与canal结合的客户端，开箱即用。这不写了</p></div><!--[--><!--]--></div><footer class="page-meta"><!----><div class="meta-item last-updated"><span class="meta-item-label">Last Updated: </span><!----></div><div class="meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: 1743760069@qq.com">liushun</span><!----><!--]--><!--]--></span></div></footer><nav class="page-nav"><p class="inner"><span class="prev"><a href="/home/master/redis/2.html" class="" aria-label="Redis实战"><!--[--><!--]--> Redis实战 <!--[--><!--]--></a></span><span class="next"><a href="/home/master/redis/4.html" class="" aria-label="Redis原理"><!--[--><!--]--> Redis原理 <!--[--><!--]--></a></span></p></nav><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="/home/assets/app-4044199c.js" defer></script>
  </body>
</html>
